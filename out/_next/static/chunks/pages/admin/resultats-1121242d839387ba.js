(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[783],{1728:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/resultats",function(){return r(3432)}])},3432:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>a});var n=r(7876),i=r(4232),s=r(4613),l=r(8313);function a(){let[e,t]=(0,i.useState)(!1),[r,a]=(0,i.useState)(!0),[o,d]=(0,i.useState)([]),[u,c]=(0,i.useState)(""),[m,h]=(0,i.useState)([]),[g,p]=(0,i.useState)([]),[x,f]=(0,i.useState)([]);return((0,i.useEffect)(()=>{!async function(){let{data:{user:e}}=await s.N.auth.getUser();if(e){let{data:r}=await s.N.from("members").select("is_admin").eq("user_id",e.id).single();t(!!(null==r?void 0:r.is_admin))}a(!1)}()},[]),(0,i.useEffect)(()=>{r||s.N.from("editions").select("id, title, group_id").order("id").then(e=>{let{data:t}=e;t&&d(t)})},[r]),(0,i.useEffect)(()=>{if(!u){h([]),p([]),f([]);return}!async function(){try{let n=o.find(e=>e.id===u);if(!n)return;let{data:i}=await s.N.from("editions_questions").select("question_id").eq("edition_id",u);if(!i||0===i.length)return void p([]);let l=i.map(e=>e.question_id),{data:a}=await s.N.from("questions").select("id, text").in("id",l),{data:d}=await s.N.from("members").select("id, name, group_id").eq("group_id",n.group_id).order("name"),{data:c}=await s.N.from("votes").select("id, question_id, voter_id, member_id, ranking").eq("edition_id",u);if(p(a||[]),f(d||[]),a&&d&&c){var e,t,r;let n=(e=a,t=d,r=c,e.map(e=>{let n=r.filter(t=>t.question_id===e.id);return{question:e,memberScores:t.map(e=>{let t=n.filter(t=>t.member_id===e.id);if(0===t.length)return{member:e,averageRank:null,voteCount:0,totalPoints:0};let r=t.reduce((e,t)=>e+t.ranking,0)/t.length,i=Math.max(...n.map(e=>e.ranking)),s=t.reduce((e,t)=>e+(i+1-t.ranking),0);return{member:e,averageRank:r,voteCount:t.length,totalPoints:s,votes:t}}).filter(e=>null!==e.averageRank).sort((e,t)=>e.averageRank-t.averageRank),totalVotes:n.length}}));h(n)}}catch(e){console.error("Erreur lors du chargement des r\xe9sultats:",e)}}()},[u,o]),r)?(0,n.jsx)("div",{className:"container",children:(0,n.jsx)("div",{className:"page-container",children:(0,n.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,n.jsx)("div",{className:"loading"}),(0,n.jsx)("p",{children:"Chargement..."})]})})}):(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)(l.A,{isAdmin:e}),(0,n.jsxs)("div",{className:"page-container",children:[(0,n.jsx)("h1",{children:"\uD83C\uDFC6 R\xe9sultats des votes"}),(0,n.jsxs)("div",{style:{marginBottom:"30px"},children:[(0,n.jsx)("label",{children:"Choisir une \xe9dition :"}),(0,n.jsxs)("select",{value:u,onChange:e=>c(Number(e.target.value)),children:[(0,n.jsx)("option",{value:"",children:"-- S\xe9lectionner une \xe9dition --"}),o.map(e=>(0,n.jsx)("option",{value:e.id,children:e.title},e.id))]})]}),u&&0===g.length&&(0,n.jsx)("div",{className:"warning",children:"Aucune question n'est associ\xe9e \xe0 cette \xe9dition."}),m.map((e,t)=>{var r,i,s,l,a,o;return(0,n.jsxs)("div",{style:{marginBottom:"50px",background:"white",padding:"30px",borderRadius:"8px",border:"1px solid #dee2e6"},children:[(0,n.jsx)("h2",{style:{color:"#495057",marginBottom:"20px"},children:e.question.text}),(0,n.jsxs)("div",{style:{color:"#666",marginBottom:"20px",fontSize:"14px"},children:[e.totalVotes," vote(s) • ",e.memberScores.length," participant(s) class\xe9(s)"]}),0===e.memberScores.length?(0,n.jsx)("div",{className:"warning",children:"Aucun vote pour cette question"}):(0,n.jsxs)("div",{children:[e.memberScores.length>=3&&(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignItems:"end",marginBottom:"30px",gap:"20px"},children:[(0,n.jsxs)("div",{style:{textAlign:"center",background:"#f8f9fa",padding:"20px",borderRadius:"8px",minWidth:"120px"},children:[(0,n.jsx)("div",{style:{fontSize:"40px"},children:"\uD83E\uDD48"}),(0,n.jsx)("div",{style:{fontWeight:"bold",fontSize:"18px"},children:null==(r=e.memberScores[1])?void 0:r.member.name}),(0,n.jsxs)("div",{style:{color:"#666",fontSize:"14px"},children:["Rang moyen: ",null==(i=e.memberScores[1])?void 0:i.averageRank.toFixed(2)]})]}),(0,n.jsxs)("div",{style:{textAlign:"center",background:"#fff3cd",padding:"30px 20px",borderRadius:"8px",minWidth:"120px",border:"2px solid #ffc107"},children:[(0,n.jsx)("div",{style:{fontSize:"50px"},children:"\uD83E\uDD47"}),(0,n.jsx)("div",{style:{fontWeight:"bold",fontSize:"20px",color:"#856404"},children:null==(s=e.memberScores[0])?void 0:s.member.name}),(0,n.jsxs)("div",{style:{color:"#856404",fontSize:"14px"},children:["Rang moyen: ",null==(l=e.memberScores[0])?void 0:l.averageRank.toFixed(2)]})]}),(0,n.jsxs)("div",{style:{textAlign:"center",background:"#f8f9fa",padding:"20px",borderRadius:"8px",minWidth:"120px"},children:[(0,n.jsx)("div",{style:{fontSize:"40px"},children:"\uD83E\uDD49"}),(0,n.jsx)("div",{style:{fontWeight:"bold",fontSize:"18px"},children:null==(a=e.memberScores[2])?void 0:a.member.name}),(0,n.jsxs)("div",{style:{color:"#666",fontSize:"14px"},children:["Rang moyen: ",null==(o=e.memberScores[2])?void 0:o.averageRank.toFixed(2)]})]})]}),(0,n.jsxs)("table",{style:{marginTop:"20px"},children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Rang"}),(0,n.jsx)("th",{children:"Participant"}),(0,n.jsx)("th",{children:"Rang moyen"}),(0,n.jsx)("th",{children:"Nombre de votes"}),(0,n.jsx)("th",{children:"Points totaux"})]})}),(0,n.jsx)("tbody",{children:e.memberScores.map((t,r)=>(0,n.jsxs)("tr",{style:{background:r<3?function(e,t){if(1===e)return"#gold";if(2===e)return"#silver";if(3===e)return"#cd7f32";let r=(e-1)/(t-1),n=Math.floor(255*r),i=Math.floor(255*(1-r));return"rgb(".concat(n,", ").concat(i,", 100)")}(r+1,e.memberScores.length):"transparent"},children:[(0,n.jsxs)("td",{style:{textAlign:"center",fontWeight:"bold",fontSize:"18px"},children:["#",r+1]}),(0,n.jsx)("td",{style:{fontWeight:"bold"},children:t.member.name}),(0,n.jsx)("td",{style:{textAlign:"center"},children:t.averageRank.toFixed(2)}),(0,n.jsx)("td",{style:{textAlign:"center"},children:t.voteCount}),(0,n.jsx)("td",{style:{textAlign:"center"},children:t.totalPoints})]},t.member.id))})]})]})]},e.question.id)})]})]})}},4531:(e,t,r)=>{"use strict";r.d(t,{_:()=>i}),r(4232);var n=r(4613);async function i(){try{let{data:{user:e}}=await n.N.auth.getUser();if(!e)return!1;let{data:t,error:r}=await n.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!r&&t)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:i}=await n.N.from("members").select("is_admin").eq("user_id",e.id).single(),s=!!(null==i?void 0:i.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!i,is_admin:null==i?void 0:i.is_admin,result:s}),s}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,t,r)=>{"use strict";r.d(t,{N:()=>n});let n=(0,r(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var n=r(4232),i=r(4613),s=r(4531);let l=()=>{let[e,t]=(0,n.useState)(null),[r,l]=(0,n.useState)(null),[a,o]=(0,n.useState)(!0),[d,u]=(0,n.useState)(!1),c=async(e,t)=>{try{var r;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",t);let{data:n,error:s}=await i.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:n,error:s}),s||!n){console.log("\uD83D\uDD0D Recherche par email...");let{data:r,error:l}=await i.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",t).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:r,emailError:l}),r&&!l&&(await i.N.from("members").update({user_id:e}).eq("id",r.id),n=r,s=l)}if(s||!n)return console.log("❌ Membre non trouv\xe9:",null==s?void 0:s.message),null;console.log("✅ Donn\xe9es membre brutes:",n);let l={...n,groups:(null==(r=n.member_groups)?void 0:r.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",l),l}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let r={id:e.id,email:e.email,user_metadata:e.user_metadata};t(e=>(null==e?void 0:e.id)===r.id?e:r),console.log("\uD83D\uDC64 User state mis \xe0 jour:",r);let n=await c(e.id,e.email);l(e=>(null==e?void 0:e.user_id)===(null==n?void 0:n.user_id)?e:n),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),t(null),l(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),t(null),l(null)}finally{o(!1)}},h=async(e,t)=>{try{o(!0);let{error:r}=await i.N.auth.signInWithPassword({email:e,password:t});if(r)return{error:r.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},g=async(e,t,r)=>{try{o(!0);let{error:n}=await i.N.auth.signUp({email:e,password:t,options:{data:{full_name:r}}});if(n)return{error:n.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},p=async()=>{o(!0),await i.N.auth.signOut(),t(null),l(null),o(!1)};return(0,n.useEffect)(()=>{m();let{data:{subscription:e}}=i.N.auth.onAuthStateChange(async(e,r)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(t(null),l(null),o(!1))});return()=>e.unsubscribe()},[]),(0,n.useEffect)(()=>{!async function(){if(null==e?void 0:e.id){let t=await (0,s._)();u(t),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:t})}else u(!1)}()},[null==e?void 0:e.id]),{user:e,member:r,isLoading:a,isAdmin:d,signIn:h,signUp:g,signOut:p,refreshUser:m}}},7670:(e,t,r)=>{"use strict";r.d(t,{W:()=>s});var n=r(4232),i=r(4613);let s=()=>{let[e,t]=(0,n.useState)(null),[r,s]=(0,n.useState)(null),[l,a]=(0,n.useState)(!0),o=async(e,t)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",t);let{data:r,error:n}=await i.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:r,error:n}),n||!r)return console.log("❌ Super admin non trouv\xe9:",null==n?void 0:n.message),null;return console.log("✅ Super admin trouv\xe9:",r),r}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},d=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let r={id:e.id,email:e.email,user_metadata:e.user_metadata};t(e=>(null==e?void 0:e.id)===r.id?e:r),console.log("\uD83D\uDC64 User state mis \xe0 jour:",r);let n=await o(e.id,e.email);s(e=>(null==e?void 0:e.user_id)===(null==n?void 0:n.user_id)?e:n),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),t(null),s(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),t(null),s(null)}finally{a(!1)}},u=async(e,t)=>{try{a(!0);let{error:r}=await i.N.auth.signInWithPassword({email:e,password:t});if(r)return{error:r.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{a(!1)}},c=async()=>{await i.N.auth.signOut(),t(null),s(null)};(0,n.useEffect)(()=>{d();let e=i.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await d():"SIGNED_OUT"===e&&(t(null),s(null),a(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!r;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:r,isSuperAdmin:m}),{user:e,superAdmin:r,isLoading:l,isSuperAdmin:m,signIn:u,signOut:c,refreshUser:d}}},8313:(e,t,r)=>{"use strict";r.d(t,{A:()=>d});var n=r(7876),i=r(8230),s=r.n(i),l=r(9099),a=r(6930),o=r(7670);function d(e){let{isAdmin:t}=e,r=(0,l.useRouter)(),{user:i,member:d,signOut:u}=(0,a.A)(),{isSuperAdmin:c}=(0,o.W)(),m=t||c;return(0,n.jsx)("nav",{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)(s(),{href:"/",className:"/"===r.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,n.jsx)("li",{children:(0,n.jsx)(s(),{href:"/identite",className:"/identite"===r.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,n.jsx)("li",{children:(0,n.jsx)(s(),{href:"/admin",className:r.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),i&&(0,n.jsxs)("li",{className:"nav-user-section",children:[(0,n.jsxs)("div",{className:"nav-user-info",children:[(0,n.jsx)("span",{className:"nav-user-name",children:d?"".concat(d.prenom," ").concat(d.nom):i.email}),m&&(0,n.jsx)("span",{className:"nav-admin-badge",children:c?"Super Admin":"Admin"})]}),(0,n.jsx)("button",{onClick:u,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!i&&(0,n.jsx)("li",{children:(0,n.jsx)(s(),{href:"/auth/login",className:"/auth/login"===r.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=1728)),_N_E=e.O()}]);