(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[862],{4531:(e,r,s)=>{"use strict";s.d(r,{_:()=>i}),s(4232);var t=s(4613);async function i(){try{let{data:{user:e}}=await t.N.auth.getUser();if(!e)return!1;let{data:r,error:s}=await t.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!s&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:i}=await t.N.from("members").select("is_admin").eq("user_id",e.id).single(),n=!!(null==i?void 0:i.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!i,is_admin:null==i?void 0:i.is_admin,result:n}),n}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,s)=>{"use strict";s.d(r,{N:()=>t});let t=(0,s(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,r,s)=>{"use strict";s.d(r,{A:()=>a});var t=s(4232),i=s(4613),n=s(4531);let a=()=>{let[e,r]=(0,t.useState)(null),[s,a]=(0,t.useState)(null),[l,o]=(0,t.useState)(!0),[u,c]=(0,t.useState)(!1),d=async(e,r)=>{try{var s;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:t,error:n}=await i.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:t,error:n}),n||!t){console.log("\uD83D\uDD0D Recherche par email...");let{data:s,error:a}=await i.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:s,emailError:a}),s&&!a&&(await i.N.from("members").update({user_id:e}).eq("id",s.id),t=s,n=a)}if(n||!t)return console.log("❌ Membre non trouv\xe9:",null==n?void 0:n.message),null;console.log("✅ Donn\xe9es membre brutes:",t);let a={...t,groups:(null==(s=t.member_groups)?void 0:s.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let s={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===s.id?e:s),console.log("\uD83D\uDC64 User state mis \xe0 jour:",s);let t=await d(e.id,e.email);a(e=>(null==e?void 0:e.user_id)===(null==t?void 0:t.user_id)?e:t),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),a(null)}finally{o(!1)}},p=async(e,r)=>{try{o(!0);let{error:s}=await i.N.auth.signInWithPassword({email:e,password:r});if(s)return{error:s.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},h=async(e,r,s)=>{try{o(!0);let{error:t}=await i.N.auth.signUp({email:e,password:r,options:{data:{full_name:s}}});if(t)return{error:t.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await i.N.auth.signOut(),r(null),a(null),o(!1)};return(0,t.useEffect)(()=>{m();let{data:{subscription:e}}=i.N.auth.onAuthStateChange(async(e,s)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),a(null),o(!1))});return()=>e.unsubscribe()},[]),(0,t.useEffect)(()=>{!async function(){if(null==e?void 0:e.id){let r=await (0,n._)();c(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else c(!1)}()},[null==e?void 0:e.id]),{user:e,member:s,isLoading:l,isAdmin:u,signIn:p,signUp:h,signOut:g,refreshUser:m}}},7670:(e,r,s)=>{"use strict";s.d(r,{W:()=>n});var t=s(4232),i=s(4613);let n=()=>{let[e,r]=(0,t.useState)(null),[s,n]=(0,t.useState)(null),[a,l]=(0,t.useState)(!0),o=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:s,error:t}=await i.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:s,error:t}),t||!s)return console.log("❌ Super admin non trouv\xe9:",null==t?void 0:t.message),null;return console.log("✅ Super admin trouv\xe9:",s),s}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},u=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let s={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===s.id?e:s),console.log("\uD83D\uDC64 User state mis \xe0 jour:",s);let t=await o(e.id,e.email);n(e=>(null==e?void 0:e.user_id)===(null==t?void 0:t.user_id)?e:t),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),n(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),n(null)}finally{l(!1)}},c=async(e,r)=>{try{l(!0);let{error:s}=await i.N.auth.signInWithPassword({email:e,password:r});if(s)return{error:s.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},d=async()=>{await i.N.auth.signOut(),r(null),n(null)};(0,t.useEffect)(()=>{u();let e=i.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await u():"SIGNED_OUT"===e&&(r(null),n(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!s;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:s,isSuperAdmin:m}),{user:e,superAdmin:s,isLoading:a,isSuperAdmin:m,signIn:c,signOut:d,refreshUser:u}}},8313:(e,r,s)=>{"use strict";s.d(r,{A:()=>u});var t=s(7876),i=s(8230),n=s.n(i),a=s(9099),l=s(6930),o=s(7670);function u(e){let{isAdmin:r}=e,s=(0,a.useRouter)(),{user:i,member:u,signOut:c}=(0,l.A)(),{isSuperAdmin:d}=(0,o.W)(),m=r||d;return(0,t.jsx)("nav",{children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:(0,t.jsx)(n(),{href:"/",className:"/"===s.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,t.jsx)("li",{children:(0,t.jsx)(n(),{href:"/identite",className:"/identite"===s.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,t.jsx)("li",{children:(0,t.jsx)(n(),{href:"/admin",className:s.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),i&&(0,t.jsxs)("li",{className:"nav-user-section",children:[(0,t.jsxs)("div",{className:"nav-user-info",children:[(0,t.jsx)("span",{className:"nav-user-name",children:u?"".concat(u.prenom," ").concat(u.nom):i.email}),m&&(0,t.jsx)("span",{className:"nav-admin-badge",children:d?"Super Admin":"Admin"})]}),(0,t.jsx)("button",{onClick:c,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!i&&(0,t.jsx)("li",{children:(0,t.jsx)(n(),{href:"/auth/login",className:"/auth/login"===s.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},8482:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>u});var t=s(7876),i=s(4232),n=s(9099),a=s(4613),l=s(4531),o=s(8313);function u(){(0,n.useRouter)();let[e,r]=(0,i.useState)([]),[s,u]=(0,i.useState)(!0),[c,d]=(0,i.useState)(""),[m,p]=(0,i.useState)(null),[h,g]=(0,i.useState)(!1),[f,v]=(0,i.useState)(""),[N,j]=(0,i.useState)("");async function x(){u(!0);let{data:e,error:s}=await a.N.from("groups").select("*").order("id");!s&&e?r(e):s&&v("Erreur lors du chargement des groupes : "+s.message),u(!1)}async function _(e){if(e.preventDefault(),v(""),j(""),!c.trim())return void v("Le nom du groupe est requis");try{if(m){let{error:e}=await a.N.from("groups").update({name:c.trim()}).eq("id",m);if(e)throw e;j("Groupe modifi\xe9 avec succ\xe8s")}else{let{error:e}=await a.N.from("groups").insert({name:c.trim()});if(e)throw e;j("Groupe ajout\xe9 avec succ\xe8s")}d(""),p(null),x()}catch(e){v("Erreur : "+e.message)}}async function b(r){let s=e.find(e=>e.id===r),t=(null==s?void 0:s.name)||"ID ".concat(r);if(confirm('Supprimer le groupe "'.concat(t,'" ?\n\n⚠️ Cette action supprimera aussi :\n- Tous les membres de ce groupe\n- Toutes les \xe9ditions de ce groupe\n- Tous les votes associ\xe9s\n\nCette action est irr\xe9versible !'))){v(""),j("");try{console.log("\uD83D\uDDD1️ D\xe9but suppression du groupe ".concat(t," (ID: ").concat(r,")"));let{data:e,error:s}=await a.N.from("editions").select("id").eq("group_id",r);if(s)console.error("Erreur lors de la r\xe9cup\xe9ration des \xe9ditions:",s);else if(e&&e.length>0){let r=e.map(e=>e.id);console.log("\uD83D\uDCCA Suppression des votes pour ".concat(r.length," \xe9ditions"));let{error:s}=await a.N.from("votes").delete().in("edition_id",r);s&&console.error("Erreur lors de la suppression des votes:",s)}let{error:i}=await a.N.from("member_groups").delete().eq("group_id",r);i&&console.error("Erreur lors de la suppression des associations membre-groupe:",i);let{error:n}=await a.N.from("editions").delete().eq("group_id",r);n&&console.error("Erreur lors de la suppression des \xe9ditions:",n);let{error:l}=await a.N.from("members").update({group_id:null}).eq("group_id",r);l&&console.error("Erreur lors de la mise \xe0 jour des membres:",l);let{error:o}=await a.N.from("groups").delete().eq("id",r);if(o)throw o;j('Groupe "'.concat(t,'" supprim\xe9 avec succ\xe8s !')),x()}catch(e){v("Erreur lors de la suppression : "+e.message),console.error("❌ Erreur compl\xe8te:",e)}}}return(0,i.useEffect)(()=>{!async function(){try{let e=await (0,l._)();console.log("\uD83D\uDD11 V\xe9rification admin groupes:",e),g(e)}catch(e){console.error("❌ Erreur v\xe9rification admin:",e),g(!1)}finally{u(!1)}}()},[]),(0,i.useEffect)(()=>{h&&x()},[h]),s?(0,t.jsx)("div",{className:"container",children:(0,t.jsx)("div",{className:"page-container",children:(0,t.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,t.jsx)("div",{className:"loading"}),(0,t.jsx)("p",{children:"Chargement..."})]})})}):h?(0,t.jsxs)("div",{className:"container",children:[(0,t.jsx)(o.A,{isAdmin:h}),(0,t.jsxs)("div",{className:"page-container",children:[(0,t.jsx)("h1",{children:"\uD83D\uDC65 Gestion des Groupes"}),(0,t.jsxs)("form",{onSubmit:_,style:{marginBottom:"30px"},children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{children:"Nom du groupe :"}),(0,t.jsx)("input",{type:"text",placeholder:"Nom du groupe",value:c,onChange:e=>d(e.target.value),required:!0})]}),(0,t.jsxs)("div",{style:{display:"flex",gap:"10px",marginTop:"16px"},children:[(0,t.jsx)("button",{type:"submit",children:m?"✏️ Modifier":"➕ Ajouter"}),m&&(0,t.jsx)("button",{type:"button",className:"secondary",onClick:()=>{p(null),d(""),v(""),j("")},children:"❌ Annuler"})]})]}),f&&(0,t.jsx)("div",{className:"error",children:f}),N&&(0,t.jsx)("div",{className:"success",children:N}),0===e.length?(0,t.jsx)("div",{className:"warning",children:"Aucun groupe cr\xe9\xe9. Cr\xe9ez votre premier groupe ci-dessus."}):(0,t.jsxs)("table",{children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"ID"}),(0,t.jsx)("th",{children:"Nom du groupe"}),(0,t.jsx)("th",{children:"Actions"})]})}),(0,t.jsx)("tbody",{children:e.map(e=>(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:e.id}),(0,t.jsx)("td",{style:{fontWeight:m===e.id?"bold":"normal"},children:e.name}),(0,t.jsx)("td",{children:(0,t.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,t.jsx)("button",{onClick:()=>{p(e.id),d(e.name),v(""),j("")},className:"secondary small",disabled:m===e.id,children:"✏️ Modifier"}),(0,t.jsx)("button",{onClick:()=>b(e.id),className:"danger small",children:"\uD83D\uDDD1️ Supprimer"})]})})]},e.id))})]})]})]}):(0,t.jsx)("div",{className:"container",children:(0,t.jsx)("div",{className:"page-container",children:(0,t.jsx)("div",{className:"error",children:"Acc\xe8s refus\xe9. Vous devez \xeatre administrateur pour acc\xe9der \xe0 cette page."})})})}},9228:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/groupes",function(){return s(8482)}])}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=9228)),_N_E=e.O()}]);