(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[913],{415:(e,r,s)=>{"use strict";s.d(r,{A:()=>u});var t=s(7876),n=s(9099),i=s(8230),a=s.n(i),l=s(6930);function u(e){let{className:r=""}=e,s=(0,n.useRouter)(),{user:i,member:u,isAdmin:o,signOut:c}=(0,l.A)();return i?(0,t.jsx)("nav",{className:"global-nav ".concat(r),children:(0,t.jsxs)("div",{className:"nav-container",children:[(0,t.jsxs)("div",{className:"nav-left",children:[(0,t.jsx)(a(),{href:"/",className:"nav-button ".concat("/"===s.pathname?"active":""),children:"\uD83C\uDFE0 Accueil"}),(0,t.jsx)(a(),{href:"/vote",className:"nav-button ".concat("/vote"===s.pathname?"active":""),children:"\uD83D\uDDF3️ Voter"}),o&&(0,t.jsx)(a(),{href:"/admin",className:"nav-button ".concat(s.pathname.startsWith("/admin")?"active":""),children:"⚙️ Administration"})]}),(0,t.jsxs)("div",{className:"nav-right",children:[(0,t.jsxs)("span",{className:"user-info",children:[(null==u?void 0:u.name)||i.email,o&&(0,t.jsx)("span",{className:"admin-indicator",children:"\uD83D\uDC51"})]}),(0,t.jsx)("button",{onClick:c,className:"nav-button logout",children:"\uD83D\uDEAA D\xe9connexion"})]})]})}):null}},3566:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/editions",function(){return s(8400)}])},3610:(e,r,s)=>{"use strict";s.d(r,{EG:()=>n,Ke:()=>l,UJ:()=>a,cq:()=>i});var t=s(4613);async function n(e){try{let{data:r,error:s}=await t.N.rpc("delete_member_safely",{member_id_to_delete:e});if(s)return console.error("Erreur suppression membre:",s),{success:!1,message:"Erreur lors de la suppression: ".concat(s.message)};return{success:!0,message:r||"Membre supprim\xe9 avec succ\xe8s"}}catch(e){return console.error("Erreur inattendue:",e),{success:!1,message:"Erreur inattendue lors de la suppression"}}}async function i(e){try{let{data:r,error:s}=await t.N.rpc("delete_edition_safely",{edition_id_to_delete:e});if(s)return console.error("Erreur suppression \xe9dition:",s),{success:!1,message:"Erreur lors de la suppression: ".concat(s.message)};return{success:!0,message:r||"\xc9dition supprim\xe9e avec succ\xe8s"}}catch(e){return console.error("Erreur inattendue:",e),{success:!1,message:"Erreur inattendue lors de la suppression"}}}async function a(e){try{let{data:r,error:s}=await t.N.rpc("delete_question_safely",{question_id_to_delete:e});if(s)return console.error("Erreur suppression question:",s),{success:!1,message:"Erreur lors de la suppression: ".concat(s.message)};return{success:!0,message:r||"Question supprim\xe9e avec succ\xe8s"}}catch(e){return console.error("Erreur inattendue:",e),{success:!1,message:"Erreur inattendue lors de la suppression"}}}async function l(e,r,s,t,n,i,a){let l,u=s(e),o=t(e);if(l="\xcates-vous s\xfbr de vouloir supprimer ".concat(r,' "').concat(u,'" ?'),a&&a.length>0&&(l+="\n\n⚠️ ATTENTION:\n"+a.join("\n")),confirm(l+="\n\nCette action est irr\xe9versible."))try{let e=await n(o);e.success?alert("✅ ".concat(e.message)):alert("❌ ".concat(e.message)),e.success&&i&&i()}catch(e){console.error("Erreur lors de la suppression:",e),alert("❌ Erreur inattendue lors de la suppression")}}},4531:(e,r,s)=>{"use strict";s.d(r,{_:()=>n}),s(4232);var t=s(4613);async function n(){try{let{data:{user:e}}=await t.N.auth.getUser();if(!e)return!1;let{data:r,error:s}=await t.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!s&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:n}=await t.N.from("members").select("is_admin").eq("user_id",e.id).single(),i=!!(null==n?void 0:n.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!n,is_admin:null==n?void 0:n.is_admin,result:i}),i}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,s)=>{"use strict";s.d(r,{N:()=>t});let t=(0,s(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,r,s)=>{"use strict";s.d(r,{A:()=>a});var t=s(4232),n=s(4613),i=s(4531);let a=()=>{let[e,r]=(0,t.useState)(null),[s,a]=(0,t.useState)(null),[l,u]=(0,t.useState)(!0),[o,c]=(0,t.useState)(!1),d=async(e,r)=>{try{var s;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:t,error:i}=await n.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:t,error:i}),i||!t){console.log("\uD83D\uDD0D Recherche par email...");let{data:s,error:a}=await n.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:s,emailError:a}),s&&!a&&(await n.N.from("members").update({user_id:e}).eq("id",s.id),t=s,i=a)}if(i||!t)return console.log("❌ Membre non trouv\xe9:",null==i?void 0:i.message),null;console.log("✅ Donn\xe9es membre brutes:",t);let a={...t,groups:(null==(s=t.member_groups)?void 0:s.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await n.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let s={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===s.id?e:s),console.log("\uD83D\uDC64 User state mis \xe0 jour:",s);let t=await d(e.id,e.email);a(e=>(null==e?void 0:e.user_id)===(null==t?void 0:t.user_id)?e:t),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),a(null)}finally{u(!1)}},h=async(e,r)=>{try{u(!0);let{error:s}=await n.N.auth.signInWithPassword({email:e,password:r});if(s)return{error:s.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},p=async(e,r,s)=>{try{u(!0);let{error:t}=await n.N.auth.signUp({email:e,password:r,options:{data:{full_name:s}}});if(t)return{error:t.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{u(!0),await n.N.auth.signOut(),r(null),a(null),u(!1)};return(0,t.useEffect)(()=>{m();let{data:{subscription:e}}=n.N.auth.onAuthStateChange(async(e,s)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),a(null),u(!1))});return()=>e.unsubscribe()},[]),(0,t.useEffect)(()=>{!async function(){if(null==e?void 0:e.id){let r=await (0,i._)();c(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else c(!1)}()},[null==e?void 0:e.id]),{user:e,member:s,isLoading:l,isAdmin:o,signIn:h,signUp:p,signOut:g,refreshUser:m}}},7670:(e,r,s)=>{"use strict";s.d(r,{W:()=>i});var t=s(4232),n=s(4613);let i=()=>{let[e,r]=(0,t.useState)(null),[s,i]=(0,t.useState)(null),[a,l]=(0,t.useState)(!0),u=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:s,error:t}=await n.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:s,error:t}),t||!s)return console.log("❌ Super admin non trouv\xe9:",null==t?void 0:t.message),null;return console.log("✅ Super admin trouv\xe9:",s),s}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},o=async()=>{try{let{data:{user:e}}=await n.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let s={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===s.id?e:s),console.log("\uD83D\uDC64 User state mis \xe0 jour:",s);let t=await u(e.id,e.email);i(e=>(null==e?void 0:e.user_id)===(null==t?void 0:t.user_id)?e:t),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),i(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),i(null)}finally{l(!1)}},c=async(e,r)=>{try{l(!0);let{error:s}=await n.N.auth.signInWithPassword({email:e,password:r});if(s)return{error:s.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},d=async()=>{await n.N.auth.signOut(),r(null),i(null)};(0,t.useEffect)(()=>{o();let e=n.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await o():"SIGNED_OUT"===e&&(r(null),i(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!s;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:s,isSuperAdmin:m}),{user:e,superAdmin:s,isLoading:a,isSuperAdmin:m,signIn:c,signOut:d,refreshUser:o}}},8313:(e,r,s)=>{"use strict";s.d(r,{A:()=>o});var t=s(7876),n=s(8230),i=s.n(n),a=s(9099),l=s(6930),u=s(7670);function o(e){let{isAdmin:r}=e,s=(0,a.useRouter)(),{user:n,member:o,signOut:c}=(0,l.A)(),{isSuperAdmin:d}=(0,u.W)(),m=r||d;return(0,t.jsx)("nav",{children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:(0,t.jsx)(i(),{href:"/",className:"/"===s.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,t.jsx)("li",{children:(0,t.jsx)(i(),{href:"/identite",className:"/identite"===s.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,t.jsx)("li",{children:(0,t.jsx)(i(),{href:"/admin",className:s.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),n&&(0,t.jsxs)("li",{className:"nav-user-section",children:[(0,t.jsxs)("div",{className:"nav-user-info",children:[(0,t.jsx)("span",{className:"nav-user-name",children:o?"".concat(o.prenom," ").concat(o.nom):n.email}),m&&(0,t.jsx)("span",{className:"nav-admin-badge",children:d?"Super Admin":"Admin"})]}),(0,t.jsx)("button",{onClick:c,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!n&&(0,t.jsx)("li",{children:(0,t.jsx)(i(),{href:"/auth/login",className:"/auth/login"===s.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},8400:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>d});var t=s(7876),n=s(4232),i=s(9099),a=s(4613),l=s(4531),u=s(3610),o=s(8313),c=s(415);function d(){let e=(0,i.useRouter)(),[r,s]=(0,n.useState)([]),[d,m]=(0,n.useState)([]),[h,p]=(0,n.useState)(!0),[g,f]=(0,n.useState)(!0),[v,x]=(0,n.useState)(!1),[j,N]=(0,n.useState)(""),[_,b]=(0,n.useState)(""),[y,E]=(0,n.useState)(!1),[w,D]=(0,n.useState)(null);async function S(){let{data:e}=await a.N.from("groups").select("*").order("id");e&&m(e)}async function A(){p(!0);let{data:e,error:r}=await a.N.from("editions").select("*").order("id");!r&&e&&s(e),p(!1)}async function C(e){e.preventDefault(),_&&(w?await a.N.from("editions").update({title:j,group_id:_,no_self_vote:y}).eq("id",w):await a.N.from("editions").insert({title:j,group_id:_,no_self_vote:y}),N(""),b(""),E(!1),D(null),A())}async function I(e){let s=r.find(r=>r.id===e);if(!s)return void alert("\xc9dition introuvable");if(confirm("Supprimer l'\xe9dition \"".concat(s.title,'" ?\n\n⚠️ Cette action supprimera aussi tous les votes associ\xe9s.'))){let r=await (0,u.cq)(e);r.success?(alert("✅ ".concat(r.message)),A()):alert("❌ ".concat(r.message))}}return(0,n.useEffect)(()=>{!async function(){try{let e=await (0,l._)();console.log("\uD83D\uDD11 V\xe9rification admin \xe9ditions:",e),x(e)}catch(e){console.error("❌ Erreur v\xe9rification admin:",e),x(!1)}finally{f(!1)}}()},[]),(0,n.useEffect)(()=>{v&&!g&&(S(),A())},[v,g]),g?(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,t.jsx)(c.A,{}),(0,t.jsx)("div",{className:"flex items-center justify-center",style:{minHeight:"calc(100vh - 60px)"},children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,t.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement..."})]})})]}):v?(0,t.jsxs)("div",{children:[(0,t.jsx)(o.A,{isAdmin:v}),(0,t.jsxs)("div",{style:{padding:32},children:[(0,t.jsx)("button",{onClick:()=>e.push("/admin"),children:"← Retour \xe0 l'administration"}),(0,t.jsx)("h2",{children:"Gestion des \xc9ditions"}),(0,t.jsxs)("form",{onSubmit:C,style:{marginBottom:20},children:[(0,t.jsx)("input",{type:"text",placeholder:"Titre de l'\xe9dition",value:j,onChange:e=>N(e.target.value),required:!0}),(0,t.jsxs)("select",{value:_,onChange:e=>b(Number(e.target.value)),required:!0,children:[(0,t.jsx)("option",{value:"",children:"-- Choisir un groupe --"}),d.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,t.jsxs)("label",{style:{marginLeft:10},children:[(0,t.jsx)("input",{type:"checkbox",checked:y,onChange:e=>E(e.target.checked)})," ","Interdire l'auto-vote"]}),(0,t.jsx)("button",{type:"submit",style:{marginLeft:10},children:w?"Modifier":"Ajouter"}),w&&(0,t.jsx)("button",{type:"button",onClick:()=>{D(null),N(""),b(""),E(!1)},children:"Annuler"})]}),h?(0,t.jsx)("p",{children:"Chargement..."}):(0,t.jsxs)("table",{children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"ID"}),(0,t.jsx)("th",{children:"Titre"}),(0,t.jsx)("th",{children:"Groupe"}),(0,t.jsx)("th",{children:"Auto-vote interdit"}),(0,t.jsx)("th",{children:"Actions"})]})}),(0,t.jsx)("tbody",{children:r.map(e=>{var r;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:e.id}),(0,t.jsx)("td",{children:e.title}),(0,t.jsx)("td",{children:(null==(r=d.find(r=>r.id===e.group_id))?void 0:r.name)||"?"}),(0,t.jsx)("td",{children:e.no_self_vote?"Oui":"Non"}),(0,t.jsxs)("td",{children:[(0,t.jsx)("button",{onClick:()=>{D(e.id),N(e.title),b(e.group_id),E(!!e.no_self_vote)},children:"Editer"}),(0,t.jsx)("button",{onClick:()=>I(e.id),style:{color:"red"},children:"Supprimer"})]})]},e.id)})})]})]})]}):(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,t.jsx)(c.A,{}),(0,t.jsx)("div",{className:"flex items-center justify-center",style:{minHeight:"calc(100vh - 60px)"},children:(0,t.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto",children:(0,t.jsxs)("div",{className:"text-red-800 text-center",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Acc\xe8s refus\xe9"}),(0,t.jsx)("p",{children:"Vous devez \xeatre administrateur pour acc\xe9der \xe0 cette page."})]})})})]})}}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=3566)),_N_E=e.O()}]);