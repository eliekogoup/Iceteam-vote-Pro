(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[234],{4531:(e,r,t)=>{"use strict";t.d(r,{_:()=>n}),t(4232);var i=t(4613);async function n(){try{let{data:{user:e}}=await i.N.auth.getUser();if(!e)return!1;let{data:r,error:t}=await i.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!t&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:n}=await i.N.from("members").select("is_admin").eq("user_id",e.id).single(),s=!!(null==n?void 0:n.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!n,is_admin:null==n?void 0:n.is_admin,result:s}),s}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,t)=>{"use strict";t.d(r,{N:()=>i});let i=(0,t(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});var i=t(4232),n=t(4613),s=t(4531);let a=()=>{let[e,r]=(0,i.useState)(null),[t,a]=(0,i.useState)(null),[l,o]=(0,i.useState)(!0),[d,u]=(0,i.useState)(!1),c=async(e,r)=>{try{var t;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:i,error:s}=await n.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:i,error:s}),s||!i){console.log("\uD83D\uDD0D Recherche par email...");let{data:t,error:a}=await n.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:t,emailError:a}),t&&!a&&(await n.N.from("members").update({user_id:e}).eq("id",t.id),i=t,s=a)}if(s||!i)return console.log("❌ Membre non trouv\xe9:",null==s?void 0:s.message),null;console.log("✅ Donn\xe9es membre brutes:",i);let a={...i,groups:(null==(t=i.member_groups)?void 0:t.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await n.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let i=await c(e.id,e.email);a(i),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",i)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),a(null)}finally{o(!1)}},p=async(e,r)=>{try{o(!0);let{error:t}=await n.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},h=async(e,r,t)=>{try{o(!0);let{error:i}=await n.N.auth.signUp({email:e,password:r,options:{data:{full_name:t}}});if(i)return{error:i.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await n.N.auth.signOut(),r(null),a(null),o(!1)};return(0,i.useEffect)(()=>{m();let{data:{subscription:e}}=n.N.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),a(null),o(!1))});return()=>e.unsubscribe()},[]),(0,i.useEffect)(()=>{!async function(){if(e){let r=await (0,s._)();u(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else u(!1)}()},[e]),{user:e,member:t,isLoading:l,isAdmin:d,signIn:p,signUp:h,signOut:g,refreshUser:m}}},6977:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>l});var i=t(7876),n=t(4232),s=t(4613),a=t(8313);function l(){let[e,r]=(0,n.useState)(!1),[t,l]=(0,n.useState)(!0),[o,d]=(0,n.useState)(""),[u,c]=(0,n.useState)(""),[m,p]=(0,n.useState)([]),[h,g]=(0,n.useState)([]);async function x(){try{let[e,r]=await Promise.all([s.N.from("members").select("id, name, group_id, is_admin").order("id"),s.N.from("groups").select("id, name").order("id")]);e.data&&p(e.data),r.data&&g(r.data)}catch(e){d("Erreur lors du chargement des donn\xe9es")}}(0,n.useEffect)(()=>{!async function(){let{data:{user:e}}=await s.N.auth.getUser();if(!e){r(!1),l(!1);return}let{data:t}=await s.N.from("members").select("is_admin").eq("user_id",e.id).single();r(!!(null==t?void 0:t.is_admin)),l(!1)}()},[]),(0,n.useEffect)(()=>{e&&x()},[e]);let f=async e=>{var r;let t=null==(r=e.target.files)?void 0:r[0];if(t){d(""),c("");try{let r=(await t.text()).split("\n").filter(e=>e.trim());if(r.length<2)return void d("Le fichier CSV doit contenir au moins une ligne d'en-t\xeates et une ligne de donn\xe9es");let i=r.slice(1),n=[];for(let e=0;e<i.length;e++){let r=i[e].trim();if(!r)continue;let t=r.split(",").map(e=>e.replace(/^"|"$/g,"").trim());if(t.length<3)return void d("Ligne ".concat(e+2," : format invalide. Attendu: Nom, Groupe ID, Admin (optionnel)"));let[s,a,l]=t,o=parseInt(a),u=(null==l?void 0:l.toLowerCase())==="oui"||(null==l?void 0:l.toLowerCase())==="true";if(isNaN(o))return void d("Ligne ".concat(e+2," : Groupe ID invalide"));if(!h.find(e=>e.id===o))return void d("Ligne ".concat(e+2," : Groupe ID ").concat(o," n'existe pas"));n.push({name:s.trim(),group_id:o,is_admin:u})}if(0===n.length)return void d("Aucun membre valide trouv\xe9 dans le fichier");if(!confirm("Importer ".concat(n.length," membre(s) ? Cette action ajoutera de nouveaux membres sans supprimer les existants.")))return;let{error:a}=await s.N.from("members").insert(n);if(a)return void d("Erreur lors de l'insertion : "+a.message);c("".concat(n.length," membre(s) import\xe9(s) avec succ\xe8s !")),x(),e.target.value=""}catch(e){d("Erreur lors de la lecture du fichier : "+e.message)}}};return t?(0,i.jsx)("div",{className:"container",children:(0,i.jsx)("div",{className:"page-container",children:(0,i.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,i.jsx)("div",{className:"loading"}),(0,i.jsx)("p",{children:"Chargement..."})]})})}):e?(0,i.jsxs)("div",{className:"container",children:[(0,i.jsx)(a.A,{isAdmin:e}),(0,i.jsxs)("div",{className:"page-container",children:[(0,i.jsx)("h1",{children:"\uD83D\uDCE5\uD83D\uDCE4 Import/Export CSV"}),o&&(0,i.jsx)("div",{className:"error",children:o}),u&&(0,i.jsx)("div",{className:"success",children:u}),(0,i.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:"30px",marginTop:"30px"},children:[(0,i.jsxs)("div",{style:{background:"#f8f9fa",padding:"30px",borderRadius:"8px",border:"1px solid #dee2e6"},children:[(0,i.jsx)("h2",{children:"\uD83D\uDCE4 Export des membres"}),(0,i.jsx)("p",{style:{color:"#666",marginBottom:"20px"},children:"T\xe9l\xe9charger la liste de tous les membres au format CSV."}),(0,i.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,i.jsx)("strong",{children:"Donn\xe9es export\xe9es :"}),(0,i.jsxs)("ul",{style:{marginTop:"10px",color:"#666"},children:[(0,i.jsx)("li",{children:"ID du membre"}),(0,i.jsx)("li",{children:"Nom"}),(0,i.jsx)("li",{children:"ID et nom du groupe"}),(0,i.jsx)("li",{children:"Statut administrateur"})]})]}),(0,i.jsxs)("button",{onClick:()=>{try{let e=m.map(e=>{let r=h.find(r=>r.id===e.group_id);return[e.id,'"'.concat(e.name,'"'),e.group_id,'"'.concat((null==r?void 0:r.name)||"",'"'),e.is_admin?"Oui":"Non"]}),r=["ID,Nom,Groupe ID,Nom du Groupe,Admin",...e.map(e=>e.join(","))].join("\n"),t=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),n=URL.createObjectURL(t);i.setAttribute("href",n),i.setAttribute("download","membres_".concat(new Date().toISOString().split("T")[0],".csv")),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),c("Export r\xe9ussi !")}catch(e){d("Erreur lors de l'export")}},style:{background:"#28a745",color:"white",fontSize:"16px"},children:["\uD83D\uDCE5 T\xe9l\xe9charger CSV (",m.length," membres)"]})]}),(0,i.jsxs)("div",{style:{background:"#f8f9fa",padding:"30px",borderRadius:"8px",border:"1px solid #dee2e6"},children:[(0,i.jsx)("h2",{children:"\uD83D\uDCE5 Import des membres"}),(0,i.jsx)("p",{style:{color:"#666",marginBottom:"20px"},children:"Importer une liste de membres depuis un fichier CSV."}),(0,i.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,i.jsx)("strong",{children:"Format attendu :"}),(0,i.jsxs)("div",{style:{background:"#e9ecef",padding:"10px",borderRadius:"4px",fontFamily:"monospace",fontSize:"14px",marginTop:"10px"},children:["Nom, Groupe ID, Admin",(0,i.jsx)("br",{}),'"Jean Dupont", 1, Non',(0,i.jsx)("br",{}),'"Marie Martin", 2, Oui']})]}),(0,i.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,i.jsx)("strong",{children:"Groupes disponibles :"}),(0,i.jsx)("ul",{style:{marginTop:"10px",color:"#666"},children:h.map(e=>(0,i.jsxs)("li",{children:["ID ",e.id,": ",e.name]},e.id))})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{style:{display:"block",marginBottom:"10px"},children:"S\xe9lectionner un fichier CSV :"}),(0,i.jsx)("input",{type:"file",accept:".csv",onChange:f,style:{width:"100%",padding:"12px",border:"2px dashed #dee2e6",borderRadius:"6px",background:"white"}})]})]})]}),(0,i.jsxs)("div",{style:{marginTop:"40px"},children:[(0,i.jsx)("h2",{children:"\uD83D\uDCCA Donn\xe9es actuelles"}),(0,i.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:"20px",marginBottom:"20px"},children:[(0,i.jsxs)("div",{style:{background:"#e3f2fd",padding:"20px",borderRadius:"8px",textAlign:"center"},children:[(0,i.jsx)("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#1976d2"},children:h.length}),(0,i.jsx)("div",{style:{color:"#666"},children:"Groupes"})]}),(0,i.jsxs)("div",{style:{background:"#e8f5e8",padding:"20px",borderRadius:"8px",textAlign:"center"},children:[(0,i.jsx)("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#388e3c"},children:m.length}),(0,i.jsx)("div",{style:{color:"#666"},children:"Membres"})]}),(0,i.jsxs)("div",{style:{background:"#fff3e0",padding:"20px",borderRadius:"8px",textAlign:"center"},children:[(0,i.jsx)("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#f57c00"},children:m.filter(e=>e.is_admin).length}),(0,i.jsx)("div",{style:{color:"#666"},children:"Admins"})]})]})]})]})]}):(0,i.jsx)("div",{className:"container",children:(0,i.jsx)("div",{className:"page-container",children:(0,i.jsx)("div",{className:"error",children:"Acc\xe8s refus\xe9. Vous devez \xeatre administrateur pour acc\xe9der \xe0 cette page."})})})}},7670:(e,r,t)=>{"use strict";t.d(r,{W:()=>s});var i=t(4232),n=t(4613);let s=()=>{let[e,r]=(0,i.useState)(null),[t,s]=(0,i.useState)(null),[a,l]=(0,i.useState)(!0),o=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:t,error:i}=await n.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:t,error:i}),i||!t)return console.log("❌ Super admin non trouv\xe9:",null==i?void 0:i.message),null;return console.log("✅ Super admin trouv\xe9:",t),t}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},d=async()=>{try{let{data:{user:e}}=await n.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let i=await o(e.id,e.email);s(i),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",i)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),s(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),s(null)}finally{l(!1)}},u=async(e,r)=>{try{l(!0);let{error:t}=await n.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},c=async()=>{await n.N.auth.signOut(),r(null),s(null)};(0,i.useEffect)(()=>{d();let e=n.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await d():"SIGNED_OUT"===e&&(r(null),s(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!t;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:t,isSuperAdmin:m}),{user:e,superAdmin:t,isLoading:a,isSuperAdmin:m,signIn:u,signOut:c,refreshUser:d}}},8313:(e,r,t)=>{"use strict";t.d(r,{A:()=>d});var i=t(7876),n=t(8230),s=t.n(n),a=t(9099),l=t(6930),o=t(7670);function d(e){let{isAdmin:r}=e,t=(0,a.useRouter)(),{user:n,member:d,signOut:u}=(0,l.A)(),{isSuperAdmin:c}=(0,o.W)(),m=r||c;return(0,i.jsx)("nav",{children:(0,i.jsxs)("ul",{children:[(0,i.jsx)("li",{children:(0,i.jsx)(s(),{href:"/",className:"/"===t.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,i.jsx)("li",{children:(0,i.jsx)(s(),{href:"/identite",className:"/identite"===t.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,i.jsx)("li",{children:(0,i.jsx)(s(),{href:"/admin",className:t.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),n&&(0,i.jsxs)("li",{className:"nav-user-section",children:[(0,i.jsxs)("div",{className:"nav-user-info",children:[(0,i.jsx)("span",{className:"nav-user-name",children:d?"".concat(d.prenom," ").concat(d.nom):n.email}),m&&(0,i.jsx)("span",{className:"nav-admin-badge",children:c?"Super Admin":"Admin"})]}),(0,i.jsx)("button",{onClick:u,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!n&&(0,i.jsx)("li",{children:(0,i.jsx)(s(),{href:"/auth/login",className:"/auth/login"===t.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},8900:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/import-export",function(){return t(6977)}])}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=8900)),_N_E=e.O()}]);