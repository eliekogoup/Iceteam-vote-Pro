(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[287],{4468:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/votes",function(){return t(9084)}])},4531:(e,r,t)=>{"use strict";t.d(r,{_:()=>s}),t(4232);var i=t(4613);async function s(){try{let{data:{user:e}}=await i.N.auth.getUser();if(!e)return!1;let{data:r,error:t}=await i.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!t&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:s}=await i.N.from("members").select("is_admin").eq("user_id",e.id).single(),n=!!(null==s?void 0:s.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!s,is_admin:null==s?void 0:s.is_admin,result:n}),n}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,t)=>{"use strict";t.d(r,{N:()=>i});let i=(0,t(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});var i=t(4232),s=t(4613),n=t(4531);let a=()=>{let[e,r]=(0,i.useState)(null),[t,a]=(0,i.useState)(null),[l,o]=(0,i.useState)(!0),[u,d]=(0,i.useState)(!1),c=async(e,r)=>{try{var t;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:i,error:n}=await s.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:i,error:n}),n||!i){console.log("\uD83D\uDD0D Recherche par email...");let{data:t,error:a}=await s.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:t,emailError:a}),t&&!a&&(await s.N.from("members").update({user_id:e}).eq("id",t.id),i=t,n=a)}if(n||!i)return console.log("❌ Membre non trouv\xe9:",null==n?void 0:n.message),null;console.log("✅ Donn\xe9es membre brutes:",i);let a={...i,groups:(null==(t=i.member_groups)?void 0:t.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await s.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let i=await c(e.id,e.email);a(i),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",i)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),a(null)}finally{o(!1)}},h=async(e,r)=>{try{o(!0);let{error:t}=await s.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},p=async(e,r,t)=>{try{o(!0);let{error:i}=await s.N.auth.signUp({email:e,password:r,options:{data:{full_name:t}}});if(i)return{error:i.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await s.N.auth.signOut(),r(null),a(null),o(!1)};return(0,i.useEffect)(()=>{m();let{data:{subscription:e}}=s.N.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),a(null),o(!1))});return()=>e.unsubscribe()},[]),(0,i.useEffect)(()=>{!async function(){if(e){let r=await (0,n._)();d(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else d(!1)}()},[e]),{user:e,member:t,isLoading:l,isAdmin:u,signIn:h,signUp:p,signOut:g,refreshUser:m}}},7670:(e,r,t)=>{"use strict";t.d(r,{W:()=>n});var i=t(4232),s=t(4613);let n=()=>{let[e,r]=(0,i.useState)(null),[t,n]=(0,i.useState)(null),[a,l]=(0,i.useState)(!0),o=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:t,error:i}=await s.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:t,error:i}),i||!t)return console.log("❌ Super admin non trouv\xe9:",null==i?void 0:i.message),null;return console.log("✅ Super admin trouv\xe9:",t),t}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},u=async()=>{try{let{data:{user:e}}=await s.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let i=await o(e.id,e.email);n(i),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",i)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),n(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),n(null)}finally{l(!1)}},d=async(e,r)=>{try{l(!0);let{error:t}=await s.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},c=async()=>{await s.N.auth.signOut(),r(null),n(null)};(0,i.useEffect)(()=>{u();let e=s.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await u():"SIGNED_OUT"===e&&(r(null),n(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!t;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:t,isSuperAdmin:m}),{user:e,superAdmin:t,isLoading:a,isSuperAdmin:m,signIn:d,signOut:c,refreshUser:u}}},8313:(e,r,t)=>{"use strict";t.d(r,{A:()=>u});var i=t(7876),s=t(8230),n=t.n(s),a=t(9099),l=t(6930),o=t(7670);function u(e){let{isAdmin:r}=e,t=(0,a.useRouter)(),{user:s,member:u,signOut:d}=(0,l.A)(),{isSuperAdmin:c}=(0,o.W)(),m=r||c;return(0,i.jsx)("nav",{children:(0,i.jsxs)("ul",{children:[(0,i.jsx)("li",{children:(0,i.jsx)(n(),{href:"/",className:"/"===t.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,i.jsx)("li",{children:(0,i.jsx)(n(),{href:"/identite",className:"/identite"===t.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,i.jsx)("li",{children:(0,i.jsx)(n(),{href:"/admin",className:t.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),s&&(0,i.jsxs)("li",{className:"nav-user-section",children:[(0,i.jsxs)("div",{className:"nav-user-info",children:[(0,i.jsx)("span",{className:"nav-user-name",children:u?"".concat(u.prenom," ").concat(u.nom):s.email}),m&&(0,i.jsx)("span",{className:"nav-admin-badge",children:c?"Super Admin":"Admin"})]}),(0,i.jsx)("button",{onClick:d,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!s&&(0,i.jsx)("li",{children:(0,i.jsx)(n(),{href:"/auth/login",className:"/auth/login"===t.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},9084:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>u});var i=t(7876),s=t(4232),n=t(4613),a=t(4531),l=t(8313),o=t(7670);function u(){let[e,r]=(0,s.useState)([]),[t,u]=(0,s.useState)([]),[d,c]=(0,s.useState)([]),[m,h]=(0,s.useState)([]),[p,g]=(0,s.useState)(""),[f,x]=(0,s.useState)(!1),[v,N]=(0,s.useState)(!0),{isSuperAdmin:j}=(0,o.W)();(0,s.useEffect)(()=>{!async function(){try{let e=await (0,a._)();x(e)}catch(e){console.error("❌ Erreur lors de la v\xe9rification admin:",e),x(!1)}finally{N(!1)}}()},[]),(0,s.useEffect)(()=>{f&&n.N.from("editions").select("id, title, group_id").order("id").then(e=>{let{data:t}=e;return r(t||[])})},[f]),(0,s.useEffect)(()=>{if(!p||!f){u([]),c([]),h([]);return}(async()=>{let{data:r}=await n.N.from("editions_questions").select("question_id").eq("edition_id",p),t=(null==r?void 0:r.map(e=>e.question_id))||[],{data:i}=await n.N.from("questions").select("id, text").in("id",t);u(i||[]);let s=e.find(e=>e.id===p),a=[];if(s){let{data:e}=await n.N.from("members").select("id, name, group_id").eq("group_id",s.group_id).order("name");a=e||[]}c(a);let{data:l}=await n.N.from("votes").select("id, edition_id, question_id, voter_id, member_id, ranking").eq("edition_id",p);h(l||[])})()},[p,e,f]);let _=async e=>{if(!j)return void alert("Seuls les super-administrateurs peuvent supprimer des votes.");if(window.confirm("Supprimer ce vote ?")){let{error:r}=await n.N.from("votes").delete().eq("id",e);r?alert("Erreur lors de la suppression du vote."):h(r=>r.filter(r=>r.id!==e))}};return v?(0,i.jsx)("div",{className:"container",children:(0,i.jsx)("div",{className:"page-container",children:(0,i.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,i.jsx)("div",{className:"loading"}),(0,i.jsx)("p",{children:"Chargement..."})]})})}):f?(0,i.jsxs)("div",{className:"container",children:[(0,i.jsx)(l.A,{isAdmin:j}),(0,i.jsxs)("div",{className:"page-container",children:[(0,i.jsx)("h1",{children:"\uD83D\uDCCA Consultation des Votes"}),!j&&(0,i.jsx)("div",{style:{padding:"12px 16px",background:"rgba(59, 130, 246, 0.1)",border:"1px solid rgba(59, 130, 246, 0.2)",borderRadius:"8px",marginBottom:"20px",color:"#1e40af"},children:"ℹ️ Vous consultez les votes en mode lecture seule. Seuls les super-administrateurs peuvent supprimer des votes."}),(0,i.jsxs)("div",{style:{marginBottom:"30px"},children:[(0,i.jsx)("label",{children:"Choisir une \xe9dition :"}),(0,i.jsxs)("select",{value:p,onChange:e=>g(Number(e.target.value)),children:[(0,i.jsx)("option",{value:"",children:"-- S\xe9lectionner une \xe9dition --"}),e.map(e=>(0,i.jsx)("option",{value:e.id,children:e.title},e.id))]})]}),p&&0===t.length&&(0,i.jsx)("div",{className:"warning",children:"Aucune question n'est associ\xe9e \xe0 cette \xe9dition."}),t.map(e=>{let r=m.filter(r=>r.question_id===e.id);return(0,i.jsxs)("div",{style:{marginBottom:"40px"},children:[(0,i.jsx)("h2",{children:e.text}),0===r.length?(0,i.jsx)("div",{className:"warning",children:"Aucun vote pour cette question"}):(0,i.jsxs)("table",{children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{children:"Votant"}),d.map(e=>(0,i.jsx)("th",{children:e.name},e.id))]})}),(0,i.jsx)("tbody",{children:d.map(e=>{let t=r.filter(r=>r.voter_id===e.id);return(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{style:{fontWeight:"bold"},children:e.name}),d.map(r=>{let s=t.find(e=>e.member_id===r.id);return(0,i.jsx)("td",{style:{textAlign:"center"},children:s?(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{style:{fontWeight:"bold",fontSize:"18px",color:"#0070f3",background:"#f0f8ff",padding:"4px 8px",borderRadius:"50%",display:"inline-block",minWidth:"24px"},children:s.ranking}),(0,i.jsx)("br",{}),j&&(0,i.jsx)("button",{className:"danger small",style:{marginTop:"4px"},onClick:()=>_(s.id),title:"Supprimer ce vote (Super Admin uniquement)",children:"✕"})]}):e.id===r.id?(0,i.jsx)("span",{style:{color:"#aaa"},children:"-"}):""},r.id)})]},e.id)})})]})]},e.id)})]})]}):(0,i.jsx)("div",{className:"container",children:(0,i.jsx)("div",{className:"page-container",children:(0,i.jsx)("div",{className:"error",children:"Acc\xe8s refus\xe9. Vous devez \xeatre membre pour acc\xe9der \xe0 cette page."})})})}}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=4468)),_N_E=e.O()}]);