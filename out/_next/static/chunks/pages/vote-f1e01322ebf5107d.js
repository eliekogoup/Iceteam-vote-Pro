(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[260],{4531:(e,s,r)=>{"use strict";r.d(s,{_:()=>i}),r(4232);var n=r(4613);async function i(){try{let{data:{user:e}}=await n.N.auth.getUser();if(!e)return!1;let{data:s,error:r}=await n.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!r&&s)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:i}=await n.N.from("members").select("is_admin").eq("user_id",e.id).single(),t=!!(null==i?void 0:i.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!i,is_admin:null==i?void 0:i.is_admin,result:t}),t}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,s,r)=>{"use strict";r.d(s,{N:()=>n});let n=(0,r(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},5225:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>m});var n=r(7876),i=r(4232),t=r(9099),a=r(8230),l=r.n(a),o=r(4613),c=r(6930),d=r(6747),u=r(8313);function m(){var e;let{editionId:s}=(0,t.useRouter)().query,{user:r,member:a,isAdmin:m,isLoading:h}=(0,c.A)(),[p,g]=(0,i.useState)([]),[v,j]=(0,i.useState)([]),[x,f]=(0,i.useState)([]),[N,b]=(0,i.useState)([]),[_,y]=(0,i.useState)({}),[D,E]=(0,i.useState)(null),[w,A]=(0,i.useState)(null),[S,q]=(0,i.useState)(!1),[C,I]=(0,i.useState)(null),[R,V]=(0,i.useState)(!1),[U,k]=(0,i.useState)(!1);(0,i.useEffect)(()=>{if(r&&a){if(s)E(Number(s));else{let e=sessionStorage.getItem("editionId");e&&E(Number(e))}A(a.id)}},[r,a,s]),(0,i.useEffect)(()=>{(async()=>{let{data:e}=await o.N.from("editions").select("id, title, group_id, no_self_vote").order("id");e&&g(e)})()},[]),(0,i.useEffect)(()=>{if(!D)return;let e=p.find(e=>e.id===D);e&&(async()=>{let{data:s}=await o.N.from("members").select("id, nom, prenom, group_id").eq("group_id",e.group_id);if(s){console.debug("fetchMembers raw:",s);let r=s.map(e=>({id:e.id,name:"".concat(e.prenom," ").concat(e.nom),group_id:e.group_id}));console.debug("fetchMembers converted:",r),j(r),b(e.no_self_vote?r.filter(e=>e.id!==w):r)}})()},[p,D,w]),(0,i.useEffect)(()=>{D&&(async()=>{let{data:e}=await o.N.from("editions_questions").select("question_id, questions(id, text)").eq("edition_id",D);if(e){console.debug("fetchQuestions raw:",e);let s=e.map(e=>e.questions).filter(Boolean).flat();console.debug("fetchQuestions list:",s),f(s)}})()},[D]),(0,i.useEffect)(()=>{x.length>0&&N.length>0&&y(e=>{let s={};return x.forEach(r=>{s[r.id]=e[r.id]&&e[r.id].length===N.length?e[r.id]:[...N]}),s})},[x,N]),(0,i.useEffect)(()=>{D&&w&&(async()=>{let{data:e}=await o.N.from("votes").select("id").eq("edition_id",D).eq("voter_id",w);e&&e.length>0&&V(!0)})()},[D,w]);let z=async e=>{if(e.preventDefault(),I(null),!D||!w)return void I("Donn\xe9es manquantes pour valider le vote.");for(let e of x)if(!_[e.id]||_[e.id].length!==N.length)return void I("Merci de classer tous les membres pour chaque question.");k(!0)},F=async()=>{k(!1);let{data:e,error:s}=await o.N.from("votes").select("id").eq("edition_id",D).eq("voter_id",w);if(e&&e.length>0){V(!0),I("Vous avez d\xe9j\xe0 vot\xe9 pour cette \xe9dition.");return}let r=[];if(x.forEach(e=>{Array.isArray(_[e.id])&&_[e.id].forEach((s,n)=>{r.push({edition_id:D,question_id:e.id,voter_id:w,member_id:s.id,ranking:n+1})})}),!Array.isArray(r)||0===r.length)return void I("Aucun vote \xe0 enregistrer (bug d'initialisation du classement ?)");let{error:n}=await o.N.from("votes").insert(r);n?I("Erreur lors de l'enregistrement du vote : "+n.message):q(!0)},M=a?"".concat(a.prenom," ").concat(a.nom):"",O=(null==(e=p.find(e=>e.id===D))?void 0:e.title)||"";return h?(0,n.jsx)("div",{className:"container",children:(0,n.jsx)("div",{className:"page-container",children:(0,n.jsx)("div",{className:"loading",children:"Chargement..."})})}):r&&a?R?(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)(u.A,{isAdmin:m}),(0,n.jsx)("div",{className:"page-container",children:(0,n.jsxs)("div",{className:"vote-complete",children:[(0,n.jsx)("h1",{children:"✅ Vote d\xe9j\xe0 enregistr\xe9"}),(0,n.jsx)("p",{children:"Vous avez d\xe9j\xe0 vot\xe9 pour cette \xe9dition."}),(0,n.jsx)("p",{children:"Il n'est pas possible de voter une seconde fois."}),(0,n.jsxs)("div",{className:"post-vote-actions",children:[(0,n.jsx)(l(),{href:"/",className:"btn-primary",children:"\uD83C\uDFE0 Retour \xe0 l'accueil"}),(0,n.jsx)(l(),{href:"/results/".concat(D),className:"btn-secondary",children:"\uD83D\uDCCA Voir les r\xe9sultats"})]})]})})]}):S?(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)(u.A,{isAdmin:m}),(0,n.jsx)("div",{className:"page-container",children:(0,n.jsxs)("div",{className:"vote-success",children:[(0,n.jsx)("h1",{children:"\uD83C\uDF89 Vote enregistr\xe9 avec succ\xe8s !"}),(0,n.jsx)("p",{children:"Merci d'avoir particip\xe9 au vote !"}),(0,n.jsxs)("p",{children:["Votre classement a \xe9t\xe9 enregistr\xe9 pour l'\xe9dition : ",(0,n.jsx)("strong",{children:O})]}),(0,n.jsxs)("div",{className:"vote-summary",children:[(0,n.jsx)("h3",{children:"\uD83D\uDCCB R\xe9capitulatif de votre participation"}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Votant :"})," ",M]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\xc9dition :"})," ",O]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Questions trait\xe9es :"})," ",x.length]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Membres class\xe9s :"})," ",N.length]})]}),(0,n.jsxs)("div",{className:"post-vote-navigation",children:[(0,n.jsx)("h3",{children:"\uD83E\uDDED Que souhaitez-vous faire maintenant ?"}),(0,n.jsxs)("div",{className:"navigation-options",children:[(0,n.jsxs)(l(),{href:"/",className:"nav-option home",children:[(0,n.jsx)("span",{className:"option-icon",children:"\uD83C\uDFE0"}),(0,n.jsx)("span",{className:"option-title",children:"Retour \xe0 l'accueil"}),(0,n.jsx)("span",{className:"option-desc",children:"Voir d'autres \xe9ditions de vote"})]}),(0,n.jsxs)(l(),{href:"/results/".concat(D),className:"nav-option results",children:[(0,n.jsx)("span",{className:"option-icon",children:"\uD83D\uDCCA"}),(0,n.jsx)("span",{className:"option-title",children:"Voir les r\xe9sultats"}),(0,n.jsx)("span",{className:"option-desc",children:"Consulter le classement (si disponible)"})]}),m&&(0,n.jsxs)(l(),{href:"/admin",className:"nav-option admin",children:[(0,n.jsx)("span",{className:"option-icon",children:"⚙️"}),(0,n.jsx)("span",{className:"option-title",children:"Administration"}),(0,n.jsx)("span",{className:"option-desc",children:"G\xe9rer les votes et \xe9ditions"})]})]})]})]})})]}):null==D||null==w?(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)(u.A,{isAdmin:m}),(0,n.jsx)("div",{className:"page-container",children:(0,n.jsx)("div",{className:"loading",children:"Chargement des informations de vote..."})})]}):(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)(u.A,{isAdmin:m}),(0,n.jsxs)("div",{className:"page-container",children:[(0,n.jsxs)("div",{className:"vote-header",children:[(0,n.jsx)("h1",{children:"\uD83D\uDDF3️ Classement des membres"}),(0,n.jsxs)("div",{className:"vote-info",children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\xc9dition :"})," ",O]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Votant :"})," ",M]})]})]}),(0,n.jsxs)("form",{onSubmit:z,className:"vote-form",children:[x.length>0&&0===N.length&&(0,n.jsxs)("div",{className:"info-message",style:{marginBottom:16},children:[(0,n.jsx)("strong",{children:"Aucun membre \xe0 classer."})," V\xe9rifiez que l'\xe9dition contient des membres dans le m\xeame groupe ou que l'option \"no_self_vote\" n'a pas exclu tous les participants."]}),x.map(e=>{let s;return(0,n.jsxs)("div",{className:"question-section",children:[(0,n.jsx)("h3",{className:"question-title",children:e.text}),(0,n.jsx)("p",{className:"question-instruction",children:"Glissez-d\xe9posez les membres pour les classer (1er = meilleur)"}),(0,n.jsx)(d.JY,{onDragEnd:(s=e.id,e=>{if(!e.destination)return;let r=Array.from(_[s]||N),[n]=r.splice(e.source.index,1);r.splice(e.destination.index,0,n),y(e=>({...e,[s]:r}))}),children:(0,n.jsx)(d.gL,{droppableId:"membersList-".concat(e.id),children:s=>(0,n.jsxs)("ul",{...s.droppableProps,ref:s.innerRef,className:"members-list",children:[(_[e.id]&&_[e.id].length>0?_[e.id]:N).map((s,r)=>(0,n.jsx)(d.sx,{draggableId:s.id.toString()+"-"+e.id,index:r,children:(e,i)=>(0,n.jsxs)("li",{ref:e.innerRef,...e.draggableProps,...e.dragHandleProps,className:"member-item ".concat(i.isDragging?"dragging":""),children:[(0,n.jsxs)("span",{className:"member-rank",children:["#",r+1]}),(0,n.jsx)("span",{className:"member-name",children:s.name}),(0,n.jsx)("span",{className:"drag-indicator",children:"⋮⋮"})]})},s.id)),s.placeholder]})})})]},e.id)}),(0,n.jsxs)("div",{className:"vote-actions",children:[(0,n.jsx)("button",{type:"submit",className:"btn-primary large",children:"✅ Valider mon classement"}),C&&(0,n.jsx)("div",{className:"error-message",children:C})]})]})]}),U&&(0,n.jsx)("div",{className:"modal-overlay",children:(0,n.jsxs)("div",{className:"modal-content",children:[(0,n.jsx)("h3",{children:"Confirmation de vote"}),(0,n.jsx)("p",{children:"\xcates-vous s\xfbr de vouloir valider vos classements ?"}),(0,n.jsxs)("div",{className:"vote-summary",children:[(0,n.jsx)("h4",{children:"R\xe9sum\xe9 de vos classements :"}),x.map(e=>(0,n.jsxs)("div",{className:"question-summary",children:[(0,n.jsx)("strong",{children:e.text}),(0,n.jsx)("ol",{children:_[e.id]&&_[e.id].map((e,s)=>(0,n.jsx)("li",{children:e.name},e.id))})]},e.id))]}),(0,n.jsxs)("div",{className:"modal-actions",children:[(0,n.jsx)("button",{className:"btn-secondary",onClick:()=>k(!1),children:"Annuler"}),(0,n.jsx)("button",{className:"btn-primary",onClick:F,children:"Confirmer le vote"})]})]})})]}):(0,n.jsx)("div",{className:"container",children:(0,n.jsx)("div",{className:"page-container",children:(0,n.jsxs)("div",{className:"auth-required",children:[(0,n.jsx)("h2",{children:"\uD83D\uDD10 Connexion requise"}),(0,n.jsx)("p",{children:"Vous devez \xeatre connect\xe9 pour voter."}),(0,n.jsx)(l(),{href:"/auth/login",className:"btn-primary",children:"Se connecter"})]})})})}},6930:(e,s,r)=>{"use strict";r.d(s,{A:()=>a});var n=r(4232),i=r(4613),t=r(4531);let a=()=>{let[e,s]=(0,n.useState)(null),[r,a]=(0,n.useState)(null),[l,o]=(0,n.useState)(!0),[c,d]=(0,n.useState)(!1),u=async(e,s)=>{try{var r;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",s);let{data:n,error:t}=await i.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:n,error:t}),t||!n){console.log("\uD83D\uDD0D Recherche par email...");let{data:r,error:a}=await i.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",s).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:r,emailError:a}),r&&!a&&(await i.N.from("members").update({user_id:e}).eq("id",r.id),n=r,t=a)}if(t||!n)return console.log("❌ Membre non trouv\xe9:",null==t?void 0:t.message),null;console.log("✅ Donn\xe9es membre brutes:",n);let a={...n,groups:(null==(r=n.member_groups)?void 0:r.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let r={id:e.id,email:e.email,user_metadata:e.user_metadata};s(r),console.log("\uD83D\uDC64 User state mis \xe0 jour:",r);let n=await u(e.id,e.email);a(n),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),s(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),s(null),a(null)}finally{o(!1)}},h=async(e,s)=>{try{o(!0);let{error:r}=await i.N.auth.signInWithPassword({email:e,password:s});if(r)return{error:r.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},p=async(e,s,r)=>{try{o(!0);let{error:n}=await i.N.auth.signUp({email:e,password:s,options:{data:{full_name:r}}});if(n)return{error:n.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await i.N.auth.signOut(),s(null),a(null),o(!1)};return(0,n.useEffect)(()=>{m();let{data:{subscription:e}}=i.N.auth.onAuthStateChange(async(e,r)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(s(null),a(null),o(!1))});return()=>e.unsubscribe()},[]),(0,n.useEffect)(()=>{!async function(){if(e){let s=await (0,t._)();d(s),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:s})}else d(!1)}()},[e]),{user:e,member:r,isLoading:l,isAdmin:c,signIn:h,signUp:p,signOut:g,refreshUser:m}}},7670:(e,s,r)=>{"use strict";r.d(s,{W:()=>t});var n=r(4232),i=r(4613);let t=()=>{let[e,s]=(0,n.useState)(null),[r,t]=(0,n.useState)(null),[a,l]=(0,n.useState)(!0),o=async(e,s)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",s);let{data:r,error:n}=await i.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:r,error:n}),n||!r)return console.log("❌ Super admin non trouv\xe9:",null==n?void 0:n.message),null;return console.log("✅ Super admin trouv\xe9:",r),r}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},c=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let r={id:e.id,email:e.email,user_metadata:e.user_metadata};s(r),console.log("\uD83D\uDC64 User state mis \xe0 jour:",r);let n=await o(e.id,e.email);t(n),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),s(null),t(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),s(null),t(null)}finally{l(!1)}},d=async(e,s)=>{try{l(!0);let{error:r}=await i.N.auth.signInWithPassword({email:e,password:s});if(r)return{error:r.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},u=async()=>{await i.N.auth.signOut(),s(null),t(null)};(0,n.useEffect)(()=>{c();let e=i.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await c():"SIGNED_OUT"===e&&(s(null),t(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!r;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:r,isSuperAdmin:m}),{user:e,superAdmin:r,isLoading:a,isSuperAdmin:m,signIn:d,signOut:u,refreshUser:c}}},8313:(e,s,r)=>{"use strict";r.d(s,{A:()=>c});var n=r(7876),i=r(8230),t=r.n(i),a=r(9099),l=r(6930),o=r(7670);function c(e){let{isAdmin:s}=e,r=(0,a.useRouter)(),{user:i,member:c,signOut:d}=(0,l.A)(),{isSuperAdmin:u}=(0,o.W)(),m=s||u;return(0,n.jsx)("nav",{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)(t(),{href:"/",className:"/"===r.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,n.jsx)("li",{children:(0,n.jsx)(t(),{href:"/identite",className:"/identite"===r.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,n.jsx)("li",{children:(0,n.jsx)(t(),{href:"/admin",className:r.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),i&&(0,n.jsxs)("li",{className:"nav-user-section",children:[(0,n.jsxs)("div",{className:"nav-user-info",children:[(0,n.jsx)("span",{className:"nav-user-name",children:c?"".concat(c.prenom," ").concat(c.nom):i.email}),m&&(0,n.jsx)("span",{className:"nav-admin-badge",children:u?"Super Admin":"Admin"})]}),(0,n.jsx)("button",{onClick:d,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!i&&(0,n.jsx)("li",{children:(0,n.jsx)(t(),{href:"/auth/login",className:"/auth/login"===r.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},9804:(e,s,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/vote",function(){return r(5225)}])}},e=>{e.O(0,[289,166,8,383,636,593,792],()=>e(e.s=9804)),_N_E=e.O()}]);