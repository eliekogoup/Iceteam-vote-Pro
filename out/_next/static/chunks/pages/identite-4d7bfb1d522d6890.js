(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[402],{403:(e,r,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/identite",function(){return n(5451)}])},4531:(e,r,n)=>{"use strict";n.d(r,{_:()=>i}),n(4232);var t=n(4613);async function i(){try{let{data:{user:e}}=await t.N.auth.getUser();if(!e)return!1;let{data:r,error:n}=await t.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!n&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:i}=await t.N.from("members").select("is_admin").eq("user_id",e.id).single(),s=!!(null==i?void 0:i.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!i,is_admin:null==i?void 0:i.is_admin,result:s}),s}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,n)=>{"use strict";n.d(r,{N:()=>t});let t=(0,n(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},5451:(e,r,n)=>{"use strict";n.r(r),n.d(r,{default:()=>c});var t=n(7876),i=n(4232),s=n(9099),a=n(8230),l=n.n(a),o=n(4613),u=n(8313),d=n(6930);function c(){let e=(0,s.useRouter)(),{user:r,member:n,isAdmin:a,isLoading:c}=(0,d.A)(),[m,p]=(0,i.useState)([]),[h,g]=(0,i.useState)([]),[x,f]=(0,i.useState)(""),[v,j]=(0,i.useState)(""),[b,N]=(0,i.useState)(null);return(0,i.useEffect)(()=>{n&&(j(n.id),console.log("✅ Membre auto-d\xe9tect\xe9:",n))},[n]),(0,i.useEffect)(()=>{(async()=>{if(!n)return;let{data:e}=await o.N.from("editions").select("id, title, group_id").eq("group_id",n.group_id).order("id");e&&(p(e),console.log("\uD83D\uDCCA \xc9ditions filtr\xe9es pour le groupe",n.group_id,":",e))})()},[n]),(0,i.useEffect)(()=>{if(!x)return;let e=m.find(e=>e.id===x);e&&(async()=>{let{data:r}=await o.N.from("members").select("id, name, group_id").eq("group_id",e.group_id).order("name");g(r||[])})()},[x,m]),(0,t.jsxs)("div",{className:"container",children:[!c&&(0,t.jsx)(u.A,{isAdmin:a}),(0,t.jsxs)("div",{className:"page-container",children:[(0,t.jsx)("h1",{children:"\uD83C\uDD94 Identification pour voter"}),c?(0,t.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,t.jsx)("div",{className:"loading"}),(0,t.jsx)("p",{children:"Chargement..."})]}):r?0===m.length?(0,t.jsxs)("div",{className:"warning",children:[(0,t.jsx)("p",{children:"Aucune \xe9dition de vote disponible pour votre groupe."}),(0,t.jsx)("p",{children:"Contactez un administrateur si vous pensez que c'est une erreur."})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{style:{background:"#f8f9fa",padding:"20px",borderRadius:"8px",marginBottom:"30px",border:"1px solid #dee2e6"},children:n?(0,t.jsxs)("p",{style:{margin:0,color:"#495057"},children:[(0,t.jsx)("strong",{children:"✅ Connect\xe9 en tant que :"})," ",n.name,(0,t.jsx)("br",{}),(0,t.jsx)("strong",{children:"ℹ️ Information :"})," S\xe9lectionnez l'\xe9dition de vote \xe0 laquelle vous souhaitez participer."]}):(0,t.jsxs)("p",{style:{margin:0,color:"#495057"},children:[(0,t.jsx)("strong",{children:"ℹ️ Information :"})," S\xe9lectionnez l'\xe9dition de vote \xe0 laquelle vous souhaitez participer, puis choisissez votre nom dans la liste des participants."]})}),(0,t.jsxs)("form",{onSubmit:r=>{r.preventDefault(),N(null);let t=n?n.id:v;if(!x||!t)return void N("Merci de s\xe9lectionner une \xe9dition et votre identit\xe9.");console.log("\uD83D\uDDF3️ Acc\xe8s au vote:",{editionId:x,memberId:t}),sessionStorage.setItem("editionId",String(x)),sessionStorage.setItem("memberId",String(t)),e.push("/vote")},children:[(0,t.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,t.jsx)("label",{children:"\uD83D\uDCCB \xc9dition de vote :"}),(0,t.jsxs)("select",{value:x,onChange:e=>{f(Number(e.target.value)),n||j("")},required:!0,children:[(0,t.jsx)("option",{value:"",children:"-- Choisir une \xe9dition --"}),m.map(e=>(0,t.jsx)("option",{value:e.id,children:e.title},e.id))]})]}),x&&!n&&(0,t.jsxs)("div",{style:{marginBottom:"30px"},children:[(0,t.jsx)("label",{children:"\uD83D\uDC64 Mon identit\xe9 :"}),(0,t.jsxs)("select",{value:v,onChange:e=>j(Number(e.target.value)),required:!0,children:[(0,t.jsx)("option",{value:"",children:"-- Choisir votre nom --"}),h.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name||"".concat(e.prenom," ").concat(e.nom)},e.id))]}),0===h.length&&(0,t.jsx)("div",{className:"warning",style:{marginTop:"10px"},children:"Aucun participant trouv\xe9 pour cette \xe9dition."})]}),x&&n&&(0,t.jsx)("div",{style:{marginBottom:"30px",background:"#d4edda",padding:"15px",borderRadius:"8px",border:"1px solid #c3e6cb"},children:(0,t.jsxs)("p",{style:{margin:0,color:"#155724"},children:[(0,t.jsx)("strong",{children:"\uD83D\uDC64 Vous votez en tant que :"})," ",n.name]})}),(0,t.jsx)("button",{type:"submit",style:{fontSize:"18px",padding:"16px 32px",background:"#007bff",color:"white"},disabled:!x||!n&&!v,children:"\uD83D\uDDF3️ Acc\xe9der au vote"}),b&&(0,t.jsx)("div",{className:"error",style:{marginTop:"20px"},children:b})]}),x&&h.length>0&&(0,t.jsxs)("div",{style:{marginTop:"30px",background:"#e3f2fd",padding:"20px",borderRadius:"8px",border:"1px solid #bbdefb"},children:[(0,t.jsx)("h3",{style:{margin:"0 0 10px 0",color:"#1976d2"},children:"\uD83D\uDCCA Informations sur cette \xe9dition"}),(0,t.jsxs)("p",{style:{margin:"5px 0",color:"#495057"},children:[(0,t.jsx)("strong",{children:"Participants :"})," ",h.length," personne(s)"]}),(0,t.jsxs)("div",{style:{marginTop:"15px"},children:[(0,t.jsx)("strong",{children:"Liste des participants :"}),(0,t.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px",marginTop:"8px"},children:h.map(e=>(0,t.jsx)("span",{style:{background:"white",padding:"4px 8px",borderRadius:"12px",fontSize:"14px",border:"1px solid #ddd"},children:e.name},e.id))})]})]})]}):(0,t.jsxs)("div",{className:"auth-required",children:[(0,t.jsx)("p",{children:"Vous devez \xeatre connect\xe9 pour voter."}),(0,t.jsx)(l(),{href:"/auth/login",className:"btn-primary",children:"Se connecter"})]})]})]})}},6930:(e,r,n)=>{"use strict";n.d(r,{A:()=>a});var t=n(4232),i=n(4613),s=n(4531);let a=()=>{let[e,r]=(0,t.useState)(null),[n,a]=(0,t.useState)(null),[l,o]=(0,t.useState)(!0),[u,d]=(0,t.useState)(!1),c=async(e,r)=>{try{var n;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:t,error:s}=await i.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:t,error:s}),s||!t){console.log("\uD83D\uDD0D Recherche par email...");let{data:n,error:a}=await i.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:n,emailError:a}),n&&!a&&(await i.N.from("members").update({user_id:e}).eq("id",n.id),t=n,s=a)}if(s||!t)return console.log("❌ Membre non trouv\xe9:",null==s?void 0:s.message),null;console.log("✅ Donn\xe9es membre brutes:",t);let a={...t,groups:(null==(n=t.member_groups)?void 0:n.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",a),a}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let n={id:e.id,email:e.email,user_metadata:e.user_metadata};r(n),console.log("\uD83D\uDC64 User state mis \xe0 jour:",n);let t=await c(e.id,e.email);a(t),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),a(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),a(null)}finally{o(!1)}},p=async(e,r)=>{try{o(!0);let{error:n}=await i.N.auth.signInWithPassword({email:e,password:r});if(n)return{error:n.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},h=async(e,r,n)=>{try{o(!0);let{error:t}=await i.N.auth.signUp({email:e,password:r,options:{data:{full_name:n}}});if(t)return{error:t.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await i.N.auth.signOut(),r(null),a(null),o(!1)};return(0,t.useEffect)(()=>{m();let{data:{subscription:e}}=i.N.auth.onAuthStateChange(async(e,n)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),a(null),o(!1))});return()=>e.unsubscribe()},[]),(0,t.useEffect)(()=>{!async function(){if(e){let r=await (0,s._)();d(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else d(!1)}()},[e]),{user:e,member:n,isLoading:l,isAdmin:u,signIn:p,signUp:h,signOut:g,refreshUser:m}}},7670:(e,r,n)=>{"use strict";n.d(r,{W:()=>s});var t=n(4232),i=n(4613);let s=()=>{let[e,r]=(0,t.useState)(null),[n,s]=(0,t.useState)(null),[a,l]=(0,t.useState)(!0),o=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:n,error:t}=await i.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:n,error:t}),t||!n)return console.log("❌ Super admin non trouv\xe9:",null==t?void 0:t.message),null;return console.log("✅ Super admin trouv\xe9:",n),n}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},u=async()=>{try{let{data:{user:e}}=await i.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let n={id:e.id,email:e.email,user_metadata:e.user_metadata};r(n),console.log("\uD83D\uDC64 User state mis \xe0 jour:",n);let t=await o(e.id,e.email);s(t),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",t)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),s(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),s(null)}finally{l(!1)}},d=async(e,r)=>{try{l(!0);let{error:n}=await i.N.auth.signInWithPassword({email:e,password:r});if(n)return{error:n.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{l(!1)}},c=async()=>{await i.N.auth.signOut(),r(null),s(null)};(0,t.useEffect)(()=>{u();let e=i.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await u():"SIGNED_OUT"===e&&(r(null),s(null),l(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!n;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:n,isSuperAdmin:m}),{user:e,superAdmin:n,isLoading:a,isSuperAdmin:m,signIn:d,signOut:c,refreshUser:u}}},8313:(e,r,n)=>{"use strict";n.d(r,{A:()=>u});var t=n(7876),i=n(8230),s=n.n(i),a=n(9099),l=n(6930),o=n(7670);function u(e){let{isAdmin:r}=e,n=(0,a.useRouter)(),{user:i,member:u,signOut:d}=(0,l.A)(),{isSuperAdmin:c}=(0,o.W)(),m=r||c;return(0,t.jsx)("nav",{children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:(0,t.jsx)(s(),{href:"/",className:"/"===n.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,t.jsx)("li",{children:(0,t.jsx)(s(),{href:"/identite",className:"/identite"===n.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,t.jsx)("li",{children:(0,t.jsx)(s(),{href:"/admin",className:n.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),i&&(0,t.jsxs)("li",{className:"nav-user-section",children:[(0,t.jsxs)("div",{className:"nav-user-info",children:[(0,t.jsx)("span",{className:"nav-user-name",children:u?"".concat(u.prenom," ").concat(u.nom):i.email}),m&&(0,t.jsx)("span",{className:"nav-admin-badge",children:c?"Super Admin":"Admin"})]}),(0,t.jsx)("button",{onClick:d,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!i&&(0,t.jsx)("li",{children:(0,t.jsx)(s(),{href:"/auth/login",className:"/auth/login"===n.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}}},e=>{e.O(0,[166,8,636,593,792],()=>e(e.s=403)),_N_E=e.O()}]);