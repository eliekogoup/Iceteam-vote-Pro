(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[312],{4531:(e,r,t)=>{"use strict";t.d(r,{_:()=>s}),t(4232);var n=t(4613);async function s(){try{let{data:{user:e}}=await n.N.auth.getUser();if(!e)return!1;let{data:r,error:t}=await n.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!t&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:s}=await n.N.from("members").select("is_admin").eq("user_id",e.id).single(),i=!!(null==s?void 0:s.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!s,is_admin:null==s?void 0:s.is_admin,result:i}),i}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4613:(e,r,t)=>{"use strict";t.d(r,{N:()=>n});let n=(0,t(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},5516:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/vote-optimized",function(){return t(9325)}])},6930:(e,r,t)=>{"use strict";t.d(r,{A:()=>l});var n=t(4232),s=t(4613),i=t(4531);let l=()=>{let[e,r]=(0,n.useState)(null),[t,l]=(0,n.useState)(null),[a,o]=(0,n.useState)(!0),[u,c]=(0,n.useState)(!1),d=async(e,r)=>{try{var t;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:n,error:i}=await s.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:n,error:i}),i||!n){console.log("\uD83D\uDD0D Recherche par email...");let{data:t,error:l}=await s.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:t,emailError:l}),t&&!l&&(await s.N.from("members").update({user_id:e}).eq("id",t.id),n=t,i=l)}if(i||!n)return console.log("❌ Membre non trouv\xe9:",null==i?void 0:i.message),null;console.log("✅ Donn\xe9es membre brutes:",n);let l={...n,groups:(null==(t=n.member_groups)?void 0:t.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",l),l}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},m=async()=>{try{let{data:{user:e}}=await s.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===t.id?e:t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let n=await d(e.id,e.email);l(e=>(null==e?void 0:e.user_id)===(null==n?void 0:n.user_id)?e:n),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),l(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),l(null)}finally{o(!1)}},h=async(e,r)=>{try{o(!0);let{error:t}=await s.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return await m(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},f=async(e,r,t)=>{try{o(!0);let{error:n}=await s.N.auth.signUp({email:e,password:r,options:{data:{full_name:t}}});if(n)return{error:n.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},g=async()=>{o(!0),await s.N.auth.signOut(),r(null),l(null),o(!1)};return(0,n.useEffect)(()=>{m();let{data:{subscription:e}}=s.N.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await m():"SIGNED_OUT"===e&&(r(null),l(null),o(!1))});return()=>e.unsubscribe()},[]),(0,n.useEffect)(()=>{!async function(){if(null==e?void 0:e.id){let r=await (0,i._)();c(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else c(!1)}()},[null==e?void 0:e.id]),{user:e,member:t,isLoading:a,isAdmin:u,signIn:h,signUp:f,signOut:g,refreshUser:m}}},7670:(e,r,t)=>{"use strict";t.d(r,{W:()=>i});var n=t(4232),s=t(4613);let i=()=>{let[e,r]=(0,n.useState)(null),[t,i]=(0,n.useState)(null),[l,a]=(0,n.useState)(!0),o=async(e,r)=>{try{console.log("\uD83D\uDD0D Recherche super admin avec authUserId:",e,"email:",r);let{data:t,error:n}=await s.N.from("super_admins").select("*").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche super admin:",{data:t,error:n}),n||!t)return console.log("❌ Super admin non trouv\xe9:",null==n?void 0:n.message),null;return console.log("✅ Super admin trouv\xe9:",t),t}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du super admin:",e),null}},u=async()=>{try{let{data:{user:e}}=await s.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let t={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===t.id?e:t),console.log("\uD83D\uDC64 User state mis \xe0 jour:",t);let n=await o(e.id,e.email);i(e=>(null==e?void 0:e.user_id)===(null==n?void 0:n.user_id)?e:n),console.log("\uD83D\uDC51 Super admin state mis \xe0 jour:",n)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),i(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),i(null)}finally{a(!1)}},c=async(e,r)=>{try{a(!0);let{error:t}=await s.N.auth.signInWithPassword({email:e,password:r});if(t)return{error:t.message};return{}}catch(e){return{error:e.message||"Une erreur est survenue"}}finally{a(!1)}},d=async()=>{await s.N.auth.signOut(),r(null),i(null)};(0,n.useEffect)(()=>{u();let e=s.N.auth.onAuthStateChange(async e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await u():"SIGNED_OUT"===e&&(r(null),i(null),a(!1))});return()=>e.data.subscription.unsubscribe()},[]);let m=!!t;return console.log("\uD83D\uDC51 \xc9tat super admin calcul\xe9:",{superAdmin:t,isSuperAdmin:m}),{user:e,superAdmin:t,isLoading:l,isSuperAdmin:m,signIn:c,signOut:d,refreshUser:u}}},8313:(e,r,t)=>{"use strict";t.d(r,{A:()=>u});var n=t(7876),s=t(8230),i=t.n(s),l=t(9099),a=t(6930),o=t(7670);function u(e){let{isAdmin:r}=e,t=(0,l.useRouter)(),{user:s,member:u,signOut:c}=(0,a.A)(),{isSuperAdmin:d}=(0,o.W)(),m=r||d;return(0,n.jsx)("nav",{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/",className:"/"===t.pathname?"active":"",children:"\uD83C\uDFE0 Accueil"})}),(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/identite",className:"/identite"===t.pathname?"active":"",children:"\uD83D\uDDF3️ Voter"})}),m&&(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/admin",className:t.pathname.startsWith("/admin")?"active":"",children:"⚙️ Administration"})}),s&&(0,n.jsxs)("li",{className:"nav-user-section",children:[(0,n.jsxs)("div",{className:"nav-user-info",children:[(0,n.jsx)("span",{className:"nav-user-name",children:u?"".concat(u.prenom," ").concat(u.nom):s.email}),m&&(0,n.jsx)("span",{className:"nav-admin-badge",children:d?"Super Admin":"Admin"})]}),(0,n.jsx)("button",{onClick:c,className:"nav-logout-btn",children:"D\xe9connexion"})]}),!s&&(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/auth/login",className:"/auth/login"===t.pathname?"active":"",children:"\uD83D\uDD10 Connexion"})})]})})}},9325:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>m});var n=t(7876),s=t(4232),i=t(9099),l=t(8230),a=t.n(l),o=t(4613),u=t(6930),c=t(6747),d=t(8313);function m(){let{editionId:e}=(0,i.useRouter)().query,{user:r,member:t,isAdmin:l,isLoading:m}=(0,u.A)(),[h,f]=(0,s.useState)([]),[g,p]=(0,s.useState)(null),[_,v]=(0,s.useState)([]),[N,j]=(0,s.useState)([]),[x,b]=(0,s.useState)({}),[E,y]=(0,s.useState)(!1),[D,w]=(0,s.useState)(!1),[S,I]=(0,s.useState)(null),[C,q]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e=!0;return o.N.from("editions").select("id, title, group_id, no_self_vote").order("id").then(r=>{let{data:t,error:n}=r;if(e){if(n)return console.error("editions fetch",n);f(t||[])}}),()=>{e=!1}},[]),(0,s.useEffect)(()=>{if(e)p(Number(e));else{let e=sessionStorage.getItem("editionId");e&&p(Number(e))}},[e]),(0,s.useEffect)(()=>{t&&t.id},[t]),(0,s.useEffect)(()=>{if(!g)return;let e=h.find(e=>e.id===g);if(!e)return;let r=!1;return(async function(){let n=o.N.from("members").select("id, nom, prenom, group_id").eq("group_id",e.group_id),s=o.N.from("editions_questions").select("question_id, questions(id, text)").eq("edition_id",g),[i,l]=await Promise.all([n,s]);if(r)return;let a=(i.data||[]).map(e=>({id:e.id,name:"".concat(e.prenom," ").concat(e.nom),group_id:e.group_id})),u=(l.data||[]).map(e=>e.questions).filter(Boolean).flat(),c=e.no_self_vote&&t?a.filter(e=>e.id!==t.id):a;v(c),j(u||[]),b(e=>{let r={...e};return(u||[]).forEach(e=>{r[e.id]||(r[e.id]=c.slice())}),r})})().catch(e=>console.error("fetchBoth",e)),()=>{r=!0}},[g,h,t]),(0,s.useEffect)(()=>{if(!g||!t)return;let e=!0;return(async()=>{try{let{data:r}=await o.N.from("votes").select("id").eq("edition_id",g).eq("voter_id",t.id);if(!e)return;r&&r.length&&y(!0)}catch(e){console.error(e)}})(),()=>{e=!1}},[g,t]);let A=(0,s.useCallback)(e=>r=>{r.destination&&b(t=>{let n=Array.from(t[e]||_),[s]=n.splice(r.source.index,1);return n.splice(r.destination.index,0,s),{...t,[e]:n}})},[_]),k=(0,s.useCallback)(e=>{if(e.preventDefault(),I(null),!g||!t)return I("Donn\xe9es manquantes");for(let e of N)if(!x[e.id]||x[e.id].length!==_.length)return I("Classements incomplets");q(!0)},[g,t,N,x,_]),R=(0,s.useCallback)(async()=>{if(q(!1),!g||!t)return I("Donn\xe9es manquantes");let{data:e}=await o.N.from("votes").select("id").eq("edition_id",g).eq("voter_id",t.id);if(e&&e.length)return y(!0);let r=[];if(N.forEach(e=>{(x[e.id]||[]).forEach((n,s)=>{r.push({edition_id:g,question_id:e.id,voter_id:t.id,member_id:n.id,ranking:s+1})})}),!r.length)return I("Aucun vote \xe0 enregistrer");let{error:n}=await o.N.from("votes").insert(r);n?I(n.message):w(!0)},[g,t,N,x]),U=(0,s.useMemo)(()=>{var e;return(null==(e=h.find(e=>e.id===g))?void 0:e.title)||""},[h,g]),O=t?"".concat(t.prenom," ").concat(t.nom):"";return m?(0,n.jsx)("div",{className:"loading",children:"Chargement..."}):r&&t?E?(0,n.jsxs)("div",{className:"vote-complete",children:[(0,n.jsx)("h1",{children:"✅ Vote d\xe9j\xe0 enregistr\xe9"}),(0,n.jsx)(a(),{href:"/results/".concat(g),className:"btn-secondary",children:"\uD83D\uDCCA Voir les r\xe9sultats"})]}):D?(0,n.jsxs)("div",{className:"vote-success",children:[(0,n.jsx)("h1",{children:"\uD83C\uDF89 Vote enregistr\xe9 !"}),(0,n.jsx)("p",{children:U})]}):(0,n.jsxs)("div",{children:[(0,n.jsx)(d.A,{isAdmin:l}),(0,n.jsxs)("div",{className:"page-container",children:[(0,n.jsx)("h1",{children:"\uD83D\uDDF3️ Classement des membres (optimis\xe9)"}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\xc9dition:"})," ",U," — ",(0,n.jsx)("strong",{children:"Votant:"})," ",O]}),(0,n.jsxs)("form",{onSubmit:k,children:[N.map(e=>(0,n.jsxs)("div",{className:"question-section",children:[(0,n.jsx)("h3",{children:e.text}),(0,n.jsx)(c.JY,{onDragEnd:A(e.id),children:(0,n.jsx)(c.gL,{droppableId:"members-".concat(e.id),children:r=>(0,n.jsxs)("ul",{...r.droppableProps,ref:r.innerRef,children:[(x[e.id]&&x[e.id].length?x[e.id]:_).map((r,t)=>(0,n.jsx)(c.sx,{draggableId:"".concat(r.id,"-").concat(e.id),index:t,children:e=>(0,n.jsxs)("li",{ref:e.innerRef,...e.draggableProps,...e.dragHandleProps,children:[(0,n.jsxs)("span",{children:["#",t+1]})," ",r.name]})},r.id)),r.placeholder]})})})]},e.id)),(0,n.jsxs)("div",{children:[(0,n.jsx)("button",{type:"submit",children:"✅ Valider"}),S&&(0,n.jsx)("div",{className:"error",children:S})]})]}),C&&(0,n.jsxs)("div",{className:"modal",children:[(0,n.jsx)("p",{children:"Confirmer ?"}),(0,n.jsx)("button",{onClick:()=>q(!1),children:"Annuler"}),(0,n.jsx)("button",{onClick:R,children:"Confirmer"})]})]})]}):(0,n.jsxs)("div",{className:"auth-required",children:[(0,n.jsx)("h2",{children:"\uD83D\uDD10 Connexion requise"}),(0,n.jsx)(a(),{href:"/auth/login",className:"btn-primary",children:"Se connecter"})]})}}},e=>{e.O(0,[289,166,8,383,636,593,792],()=>e(e.s=5516)),_N_E=e.O()}]);