(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[943],{4531:(e,r,s)=>{"use strict";s.d(r,{_:()=>n}),s(4232);var i=s(4613);async function n(){try{let{data:{user:e}}=await i.N.auth.getUser();if(!e)return!1;let{data:r,error:s}=await i.N.from("super_admins").select("id").eq("user_id",e.id).eq("is_active",!0).single();if(!s&&r)return console.log("\uD83D\uDD11 Super-admin d\xe9tect\xe9 via table super_admins:",e.email),!0;let{data:n}=await i.N.from("members").select("is_admin").eq("user_id",e.id).single(),t=!!(null==n?void 0:n.is_admin);return console.log("\uD83D\uDD0D V\xe9rification admin membre:",{found:!!n,is_admin:null==n?void 0:n.is_admin,result:t}),t}catch(e){return console.error("Erreur lors de la v\xe9rification des droits admin:",e),!1}}},4554:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/debug-editions",function(){return s(7794)}])},4613:(e,r,s)=>{"use strict";s.d(r,{N:()=>i});let i=(0,s(166).UU)("https://gllqzajfkkvpwnyultiy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsbHF6YWpma2t2cHdueXVsdGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODczNjcsImV4cCI6MjA3NDY2MzM2N30.B5gXCuB2XCpT11W6unXPhFC2WX-2TsPsJA7PA32qK8E")},6930:(e,r,s)=>{"use strict";s.d(r,{A:()=>l});var i=s(4232),n=s(4613),t=s(4531);let l=()=>{let[e,r]=(0,i.useState)(null),[s,l]=(0,i.useState)(null),[o,a]=(0,i.useState)(!0),[d,u]=(0,i.useState)(!1),m=async(e,r)=>{try{var s;console.log("\uD83D\uDD0D Recherche membre avec authUserId:",e,"email:",r);let{data:i,error:t}=await n.N.from("members").select("\n          *,\n          member_groups(\n            groups(*)\n          )\n        ").eq("user_id",e).single();if(console.log("\uD83D\uDCCA R\xe9sultat recherche par user_id:",{data:i,error:t}),t||!i){console.log("\uD83D\uDD0D Recherche par email...");let{data:s,error:l}=await n.N.from("members").select("\n            *,\n            member_groups(\n              groups(*)\n            )\n          ").eq("email",r).single();console.log("\uD83D\uDCCA R\xe9sultat recherche par email:",{emailData:s,emailError:l}),s&&!l&&(await n.N.from("members").update({user_id:e}).eq("id",s.id),i=s,t=l)}if(t||!i)return console.log("❌ Membre non trouv\xe9:",null==t?void 0:t.message),null;console.log("✅ Donn\xe9es membre brutes:",i);let l={...i,groups:(null==(s=i.member_groups)?void 0:s.map(e=>e.groups))||[]};return console.log("✅ Membre avec groupes:",l),l}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration du membre:",e),null}},c=async()=>{try{let{data:{user:e}}=await n.N.auth.getUser();if(console.log("\uD83D\uDD10 Auth user r\xe9cup\xe9r\xe9:",e),e){let s={id:e.id,email:e.email,user_metadata:e.user_metadata};r(e=>(null==e?void 0:e.id)===s.id?e:s),console.log("\uD83D\uDC64 User state mis \xe0 jour:",s);let i=await m(e.id,e.email);l(e=>(null==e?void 0:e.user_id)===(null==i?void 0:i.user_id)?e:i),console.log("\uD83D\uDC65 Member state mis \xe0 jour:",i)}else console.log("❌ Aucun utilisateur authentifi\xe9"),r(null),l(null)}catch(e){console.error("Erreur lors de la r\xe9cup\xe9ration de l'utilisateur:",e),r(null),l(null)}finally{a(!1)}},g=async(e,r)=>{try{a(!0);let{error:s}=await n.N.auth.signInWithPassword({email:e,password:r});if(s)return{error:s.message};return await c(),{}}catch(e){return{error:"Erreur lors de la connexion"}}},h=async(e,r,s)=>{try{a(!0);let{error:i}=await n.N.auth.signUp({email:e,password:r,options:{data:{full_name:s}}});if(i)return{error:i.message};return{}}catch(e){return{error:"Erreur lors de l'inscription"}}},p=async()=>{a(!0),await n.N.auth.signOut(),r(null),l(null),a(!1)};return(0,i.useEffect)(()=>{c();let{data:{subscription:e}}=n.N.auth.onAuthStateChange(async(e,s)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await c():"SIGNED_OUT"===e&&(r(null),l(null),a(!1))});return()=>e.unsubscribe()},[]),(0,i.useEffect)(()=>{!async function(){if(null==e?void 0:e.id){let r=await (0,t._)();u(r),console.log("\uD83D\uDD11 \xc9tat admin mis \xe0 jour:",{user:e.email,isAdmin:r})}else u(!1)}()},[null==e?void 0:e.id]),{user:e,member:s,isLoading:o,isAdmin:d,signIn:g,signUp:h,signOut:p,refreshUser:c}}},7794:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>o});var i=s(7876),n=s(4232),t=s(6930),l=s(4613);function o(){var e,r,s,o;let{user:a,member:d}=(0,t.A)(),[u,m]=(0,n.useState)({}),[c,g]=(0,n.useState)(!0);return((0,n.useEffect)(()=>{a&&e();async function e(){g(!0);let e={user:a,member:d,steps:[]};try{e.steps.push("\uD83D\uDD0D Test connexion base de donn\xe9es...");let{data:r}=await l.N.from("members").select("count").limit(1);e.connectionOK=!!r,e.steps.push("\uD83D\uDD0D Recherche du membre avec email: ".concat(a.email));let{data:s,error:i}=await l.N.from("members").select("id, email, nom, prenom").eq("email",a.email).single();if(e.memberFound=s,e.memberError=i,s){e.steps.push("\uD83D\uDC65 Recherche des groupes du membre ID: ".concat(s.id));let{data:r,error:i}=await l.N.from("member_groups").select("group_id, groups(id, name)").eq("member_id",s.id);if(e.memberGroups=r,e.groupsError=i,r&&r.length>0){let s=r.map(e=>e.group_id);e.steps.push("\uD83D\uDCCA Recherche des \xe9ditions pour les groupes: [".concat(s.join(", "),"]"));let{data:i,error:n}=await l.N.from("editions").select("id, title, description, group_id, no_self_vote").in("group_id",s);e.editions=i,e.editionsError=n}}e.steps.push("\uD83D\uDCCB Liste de tous les membres (debug)");let{data:n}=await l.N.from("members").select("id, email, nom, prenom").limit(10);e.allMembers=n,e.steps.push("\uD83D\uDCCA Liste de toutes les \xe9ditions (debug)");let{data:t}=await l.N.from("editions").select("id, title, group_id").limit(10);e.allEditions=t}catch(r){e.error=r}m(e),g(!1)}},[a,d]),c)?(0,i.jsxs)("div",{style:{padding:"2rem"},children:[(0,i.jsx)("h1",{children:"\uD83D\uDD27 Test de diagnostic en cours..."}),(0,i.jsx)("p",{children:"Veuillez patienter pendant que nous testons la connexion aux donn\xe9es."})]}):(0,i.jsxs)("div",{style:{padding:"2rem",fontFamily:"monospace"},children:[(0,i.jsx)("h1",{children:"\uD83D\uDD27 Diagnostic des \xc9ditions"}),(0,i.jsxs)("div",{style:{background:"#f8f9fa",padding:"1rem",borderRadius:"4px",marginBottom:"1rem"},children:[(0,i.jsx)("h3",{children:"Informations utilisateur:"}),(0,i.jsx)("pre",{children:JSON.stringify({userEmail:null==(e=u.user)?void 0:e.email,member:u.member},null,2)})]}),(0,i.jsxs)("div",{style:{background:"#e8f5e8",padding:"1rem",borderRadius:"4px",marginBottom:"1rem"},children:[(0,i.jsx)("h3",{children:"\xc9tapes de diagnostic:"}),null==(r=u.steps)?void 0:r.map((e,r)=>(0,i.jsxs)("div",{children:["✓ ",e]},r))]}),(0,i.jsxs)("div",{style:{background:"#fff3cd",padding:"1rem",borderRadius:"4px",marginBottom:"1rem"},children:[(0,i.jsx)("h3",{children:"R\xe9sultats:"}),(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:"Connexion DB:"})," ",u.connectionOK?"✅ OK":"❌ Erreur"]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:"Membre trouv\xe9:"})," ",u.memberFound?"✅ Oui":"❌ Non"]}),u.memberError&&(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:"Erreur membre:"})," ",(0,i.jsx)("code",{children:JSON.stringify(u.memberError)})]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:"Groupes trouv\xe9s:"})," ",(null==(s=u.memberGroups)?void 0:s.length)||0]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:"\xc9ditions trouv\xe9es:"})," ",(null==(o=u.editions)?void 0:o.length)||0]})]}),(0,i.jsxs)("details",{style:{marginBottom:"1rem"},children:[(0,i.jsx)("summary",{children:(0,i.jsx)("strong",{children:"\uD83D\uDCCA D\xe9tails membre trouv\xe9"})}),(0,i.jsx)("pre",{style:{background:"#f8f9fa",padding:"1rem"},children:JSON.stringify(u.memberFound,null,2)})]}),(0,i.jsxs)("details",{style:{marginBottom:"1rem"},children:[(0,i.jsx)("summary",{children:(0,i.jsx)("strong",{children:"\uD83D\uDC65 D\xe9tails groupes du membre"})}),(0,i.jsx)("pre",{style:{background:"#f8f9fa",padding:"1rem"},children:JSON.stringify(u.memberGroups,null,2)})]}),(0,i.jsxs)("details",{style:{marginBottom:"1rem"},children:[(0,i.jsx)("summary",{children:(0,i.jsx)("strong",{children:"\uD83D\uDCCB D\xe9tails \xe9ditions trouv\xe9es"})}),(0,i.jsx)("pre",{style:{background:"#f8f9fa",padding:"1rem"},children:JSON.stringify(u.editions,null,2)})]}),(0,i.jsxs)("details",{style:{marginBottom:"1rem"},children:[(0,i.jsx)("summary",{children:(0,i.jsx)("strong",{children:"\uD83D\uDD0D Tous les membres dans la base"})}),(0,i.jsx)("pre",{style:{background:"#f8f9fa",padding:"1rem"},children:JSON.stringify(u.allMembers,null,2)})]}),(0,i.jsxs)("details",{style:{marginBottom:"1rem"},children:[(0,i.jsx)("summary",{children:(0,i.jsx)("strong",{children:"\uD83D\uDCCA Toutes les \xe9ditions dans la base"})}),(0,i.jsx)("pre",{style:{background:"#f8f9fa",padding:"1rem"},children:JSON.stringify(u.allEditions,null,2)})]}),u.error&&(0,i.jsxs)("div",{style:{background:"#f8d7da",padding:"1rem",borderRadius:"4px"},children:[(0,i.jsx)("h3",{children:"❌ Erreur:"}),(0,i.jsx)("pre",{children:JSON.stringify(u.error,null,2)})]})]})}}},e=>{e.O(0,[166,636,593,792],()=>e(e.s=4554)),_N_E=e.O()}]);